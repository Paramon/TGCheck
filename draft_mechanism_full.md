# –ü–æ–ª–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ (Drafts) –≤ Telegram Desktop

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä](#–∫—Ä–∞—Ç–∫–∏–π-–æ–±–∑–æ—Ä)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤)
3. [–ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞](#–ø—Ä–æ—Ü–µ—Å—Å-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è-—Ç–µ–∫—Å—Ç–∞)
4. [Typing Indicator (–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç")](#typing-indicator)
5. [–õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤](#–ª–æ–∫–∞–ª—å–Ω–æ–µ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ-—á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤)
6. [–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞–∫–æ–º](#—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è-—Å-–æ–±–ª–∞–∫–æ–º)
7. [–ü–æ–ª—É—á–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞](#–ø–æ–ª—É—á–µ–Ω–∏–µ-—á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤-—Å-—Å–µ—Ä–≤–µ—Ä–∞)
8. [Streamed Drafts (–°–æ–≤–º–µ—Å—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)](#streamed-drafts)
9. [–í—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∏ —Ç–∞–π–º–∞—É—Ç—ã](#–≤—Ä–µ–º–µ–Ω–Ω—ã–µ-–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã)
10. [–î–∏–∞–≥—Ä–∞–º–º—ã –∏ –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö](#–¥–∏–∞–≥—Ä–∞–º–º—ã)

---

## –ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä

### –ß—Ç–æ —Ç–∞–∫–æ–µ —á–µ—Ä–Ω–æ–≤–∏–∫?

–ß–µ—Ä–Ω–æ–≤–∏–∫ (Draft) ‚Äî —ç—Ç–æ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞, –∫–æ—Ç–æ—Ä–æ–µ:
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å –æ–±–ª–∞–∫–æ–º —á–µ—Ä–µ–∑ ~14 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
- ‚úÖ –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–µ–∫—Å—Ç, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ, –≤–µ–±-–ø—Ä–µ–≤—å—é
- ‚ùå **–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–∏ typing indicator**

### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

```
–°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö:
‚îú‚îÄ‚îÄ data/data_drafts.h                      - –ö–ª–∞—Å—Å—ã Draft, DraftKey, WebPageDraft
‚îî‚îÄ‚îÄ data/data_drafts.cpp                    - –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –∏ —É—Ç–∏–ª–∏—Ç—ã

Typing indicator:
‚îú‚îÄ‚îÄ api/api_send_progress.h                 - Enum SendProgressType
‚îî‚îÄ‚îÄ api/api_send_progress.cpp               - –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ typing

UI –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
‚îú‚îÄ‚îÄ history/view/controls/
‚îÇ   ‚îî‚îÄ‚îÄ history_view_compose_controls.cpp   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞

–ò—Å—Ç–æ—Ä–∏—è –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ:
‚îú‚îÄ‚îÄ history/history.h                       - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞–º–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏
‚îú‚îÄ‚îÄ history/history.cpp                     - –§—É–Ω–∫—Ü–∏–∏ setDraft, applyCloudDraft
‚îî‚îÄ‚îÄ storage/storage_account.cpp             - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î

API –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
‚îú‚îÄ‚îÄ apiwrap.h                               - saveDraftToCloudDelayed()
‚îú‚îÄ‚îÄ apiwrap.cpp                             - saveDraftsToCloud()
‚îî‚îÄ‚îÄ api/api_updates.cpp                     - –û–±—Ä–∞–±–æ—Ç–∫–∞ updateDraftMessage

Streamed Drafts:
‚îú‚îÄ‚îÄ history/history_streamed_drafts.h       - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îî‚îÄ‚îÄ history/history_streamed_drafts.cpp     - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤

### –¢–∏–ø—ã —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ (DraftKey)

**–§–∞–π–ª:** `data/data_drafts.h:75-230`

```cpp
class DraftKey {
public:
    // –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã
    static constexpr DraftKey Local(MsgId topicRootId, PeerId monoforumPeerId);
    static constexpr DraftKey LocalEdit(MsgId topicRootId, PeerId monoforumPeerId);
    static constexpr DraftKey Cloud(MsgId topicRootId, PeerId monoforumPeerId);
    static constexpr DraftKey Scheduled();
    static constexpr DraftKey ScheduledEdit();
    static constexpr DraftKey Shortcut(BusinessShortcutId shortcutId);
    static constexpr DraftKey ShortcutEdit(BusinessShortcutId shortcutId);
};
```

#### –¢–∏–ø—ã —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤:

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
|-----|----------|-------------------|
| **Local** | –õ–æ–∫–∞–ª—å–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è | –ü—Ä–∏ –ø–µ—á–∞—Ç–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è |
| **LocalEdit** | –õ–æ–∫–∞–ª—å–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è | –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è |
| **Cloud** | –û–±–ª–∞—á–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫ | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å —Å–µ—Ä–≤–µ—Ä–æ–º |
| **Scheduled** | –ß–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è | –í —Ä–∞–∑–¥–µ–ª–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö |
| **ScheduledEdit** | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ | –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ |
| **Shortcut** | –ß–µ—Ä–Ω–æ–≤–∏–∫ –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ | –í –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç–∞—Ö |

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Draft

**–§–∞–π–ª:** `data/data_drafts.h:50-73`

```cpp
struct Draft {
    TimeId date = 0;                    // –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    TextWithTags textWithTags;          // –¢–µ–∫—Å—Ç —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    FullReplyTo reply;                  // –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ)
    SuggestPostOptions suggest;         // –û–ø—Ü–∏–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–≥–æ –ø–æ—Å—Ç–∞
    MessageCursor cursor;               // –ü–æ–∑–∏—Ü–∏—è –∫—É—Ä—Å–æ—Ä–∞
    WebPageDraft webpage;               // –í–µ–±-–ø—Ä–µ–≤—å—é
    mtpRequestId saveRequestId = 0;     // ID –∑–∞–ø—Ä–æ—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
};
```

#### –ü–æ–ª—è Draft:

- **date**: Unix timestamp —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- **textWithTags**: –¢–µ–∫—Å—Ç —Å —Ç–µ–≥–∞–º–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤, —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ —Ç.–¥.)
- **reply.messageId**:
  - –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ —á–µ—Ä–Ω–æ–≤–∏–∫–∞: ID —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–≤–µ—á–∞–µ–º
  - **–î–ª—è edit-—á–µ—Ä–Ω–æ–≤–∏–∫–∞: ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è**
- **cursor**: –ü–æ–∑–∏—Ü–∏—è –∫—É—Ä—Å–æ—Ä–∞ –∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
- **webpage**: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ–±-–ø—Ä–µ–≤—å—é (URL, forced media size)
- **saveRequestId**: ID –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ

### WebPageDraft

**–§–∞–π–ª:** `data/data_drafts.h:35-48`

```cpp
struct WebPageDraft {
    WebPageId id = 0;                   // ID –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—ã
    QString url;                        // URL
    bool forceLargeMedia : 1 = false;   // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª—å—à–æ–π –º–µ–¥–∏–∞
    bool forceSmallMedia : 1 = false;   // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –º–∞–ª–µ–Ω—å–∫–∏–π –º–µ–¥–∏–∞
    bool invert : 1 = false;            // –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é
    bool manual : 1 = false;            // –í—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π
    bool removed : 1 = false;           // –ü—Ä–µ–≤—å—é —É–¥–∞–ª–µ–Ω–æ
};
```

### –•—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –≤ History

**–§–∞–π–ª:** `history/history.h:297-299`

```cpp
Data::Draft *draft(Data::DraftKey key) const;
void setDraft(Data::DraftKey key, std::unique_ptr<Data::Draft> &&draft);
void clearDraft(Data::DraftKey key);
```

–ß–µ—Ä–Ω–æ–≤–∏–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `History` –≤ –≤–∏–¥–µ `flat_map`:

```cpp
using HistoryDrafts = base::flat_map<DraftKey, std::unique_ptr<Draft>>;
```

---

## –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞

### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç

**–§–∞–π–ª:** `history/view/controls/history_view_compose_controls.cpp:1865-1890`

```cpp
void ComposeControls::fieldChanged() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å typing indicator
    const auto typing = (!_inlineBot
        && !_header->isEditingMessage()
        && (_textUpdateEvents & TextUpdateEvent::SendTyping));

    updateSendButtonType();
    _hasSendText = HasSendText(_field);

    if (updateBotCommandShown() || updateLikeShown()) {
        updateControlsVisibility();
        updateControlsGeometry(_wrap->size());
    }

    // –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ typing –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ inline-–±–æ—Ç–∞
    InvokeQueued(_field.get(), [=] {
        updateInlineBotQuery();
        if ((!_autocomplete || !_autocomplete->stickersEmoji()) && typing) {
            _sendActionUpdates.fire({ Api::SendProgressType::Typing });  // ‚Üê TYPING!
        }
    });

    checkCharsLimitation();

    _saveCloudDraftTimer.cancel();
    if (!(_textUpdateEvents & TextUpdateEvent::SaveDraft)) {
        return;
    }
    _saveDraftText = true;
    saveDraft(true);  // ‚Üê –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
}
```

#### –£—Å–ª–æ–≤–∏—è –¥–ª—è typing indicator:

1. ‚úÖ **–ù–ï** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è inline-–±–æ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, `@gif`)
2. ‚úÖ **–ù–ï** —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
3. ‚úÖ –§–ª–∞–≥ `TextUpdateEvent::SendTyping` –∞–∫—Ç–∏–≤–µ–Ω
4. ‚úÖ **–ù–ï** –æ—Ç–∫—Ä—ã—Ç–∞ –ø–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–∫–µ—Ä–æ–≤/—ç–º–æ–¥–∑–∏ —á–µ—Ä–µ–∑ autocomplete

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç
         ‚Üì
fieldChanged() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
         ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚Üì         ‚Üì
 Typing    –õ–æ–∫–∞–ª—å–Ω–æ–µ
–æ—Ç–ø—Ä–∞–≤–∫–∞   —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
```

---

## Typing Indicator

> –ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑: `FuckTG/typing_indicator_analysis.md`

### –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è?

**–§–∞–π–ª:** `api/api_send_progress.cpp:111-152`

```cpp
void SendProgressManager::send(const Key &key, int progress) {
    if (skipRequest(key)) {
        return;
    }

    // –°–æ–∑–¥–∞–µ–º MTP action –ë–ï–ó —Ç–µ–∫—Å—Ç–∞
    const auto action = [&]() -> MTPsendMessageAction {
        switch (key.type) {
        case Type::Typing: return MTP_sendMessageTypingAction();
        case Type::RecordVideo: return MTP_sendMessageRecordVideoAction();
        // ... –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã
        }
    }();

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º messages.setTyping
    const auto requestId = _session->api().request(MTPmessages_SetTyping(
        MTP_flags(key.topMsgId
            ? MTPmessages_SetTyping::Flag::f_top_msg_id
            : MTPmessages_SetTyping::Flag(0)),
        key.history->peer->input,      // ‚Üê –ö–æ–º—É
        MTP_int(key.topMsgId),          // ‚Üê ID —Ç–µ–º—ã/—Ç—Ä–µ–¥–∞
        action                          // ‚Üê –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è (typing)
    )).done([=](const MTPBool &result, mtpRequestId requestId) {
        done(requestId);
    }).send();
}
```

### MTP –º–µ—Ç–æ–¥: messages.setTyping

**–°—Ö–µ–º–∞:** `mtproto/scheme/api.tl:2252`

```
messages.setTyping#58943ee2
    flags:#
    peer:InputPeer               ‚Üê –°–æ–±–µ—Å–µ–¥–Ω–∏–∫/—á–∞—Ç
    top_msg_id:flags.0?int      ‚Üê ID —Ç–µ–º—ã (–¥–ª—è —Ñ–æ—Ä—É–º–æ–≤)
    action:SendMessageAction     ‚Üê –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è
= Bool;
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```
messages.setTyping
    flags: 0
    peer: inputPeerUser {
        user_id: 123456789
        access_hash: 0x...
    }
    top_msg_id: 0
    action: sendMessageTypingAction
```

### –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –æ—Ç–ø—Ä–∞–≤–∫–∏

**–§–∞–π–ª:** `api/api_send_progress.cpp:21-24`

```cpp
constexpr auto kCancelTypingActionTimeout = crl::time(5000);   // 5 —Å–µ–∫
constexpr auto kSendMySpeakingInterval = 3 * crl::time(1000);  // 3 —Å–µ–∫ (–¥–ª—è –∑–≤–æ–Ω–∫–æ–≤)
constexpr auto kSendMyTypingInterval = 5 * crl::time(1000);    // 5 —Å–µ–∫ (–¥–ª—è typing)
constexpr auto kSendTypingsToOfflineFor = TimeId(30);          // 30 —Å–µ–∫
```

#### –õ–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤:

**–§–∞–π–ª:** `api/api_send_progress.cpp:85-108`

```cpp
bool SendProgressManager::updated(const Key &key, bool doing) {
    const auto now = crl::now();
    const auto i = _updated.find(key);
    if (doing) {
        const auto sendEach = (key.type == SendProgressType::Speaking)
            ? kSendMySpeakingInterval  // 3 —Å–µ–∫ –¥–ª—è Speaking
            : kSendMyTypingInterval;    // 5 —Å–µ–∫ –¥–ª—è Typing
        if (i == end(_updated)) {
            _updated.emplace(key, now + 2 * sendEach);  // –ü–µ—Ä–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ä–∞–∑—É
        } else if (i->second > now + sendEach) {
            return false;  // –ï—â–µ —Ä–∞–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        } else {
            i->second = now + 2 * sendEach;  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
        }
    } else {
        // –û—Ç–º–µ–Ω–∞ typing
        if (i == end(_updated)) {
            return false;
        } else if (i->second <= now) {
            return false;
        } else {
            _updated.erase(i);
        }
    }
    return true;
}
```

### –ö–æ–≥–¥–∞ typing –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

**–§–∞–π–ª:** `api/api_send_progress.cpp:154-171`

```cpp
bool SendProgressManager::skipRequest(const Key &key) const {
    const auto user = key.history->peer->asUser();
    if (!user) {
        return false;  // –î–ª—è –≥—Ä—É–ø–ø/–∫–∞–Ω–∞–ª–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
    } else if (user->isSelf()) {
        return true;   // –°–µ–±–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
    } else if (user->isBot() && !user->isSupport()) {
        return true;   // –ë–æ—Ç–∞–º –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º (–∫—Ä–æ–º–µ support)
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –æ–Ω–ª–∞–π–Ω
    const auto recently = base::unixtime::now() - kSendTypingsToOfflineFor;
    const auto lastseen = user->lastseen();
    if (lastseen.isRecently()) {
        return false;  // –ù–µ–¥–∞–≤–Ω–æ –±—ã–ª –æ–Ω–ª–∞–π–Ω - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
    } else if (const auto value = lastseen.onlineTill()) {
        return (value < recently);  // –ë—ã–ª –æ–Ω–ª–∞–π–Ω > 30 —Å–µ–∫ –Ω–∞–∑–∞–¥ - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
    }
    return true;  // –ù–µ –∑–Ω–∞–µ–º —Å—Ç–∞—Ç—É—Å - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
}
```

#### –£—Å–ª–æ–≤–∏—è –ø—Ä–æ–ø—É—Å–∫–∞ typing:

1. ‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–µ–±–µ (`Saved Messages`)
2. ‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç–∞–º (–∫—Ä–æ–º–µ `@support`)
3. ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –æ—Ñ—Ñ–ª–∞–π–Ω > 30 —Å–µ–∫—É–Ω–¥
4. ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∫–∞–Ω–∞–ª–∞—Ö (–Ω–µ –º–µ–≥–∞–≥—Ä—É–ø–ø–∞—Ö)

### –¢–∏–ø—ã SendProgressType

**–§–∞–π–ª:** `api/api_send_progress.h:21-36`

```cpp
enum class SendProgressType {
    Typing,              // –ü–µ—á–∞—Ç–∞–µ—Ç —Ç–µ–∫—Å—Ç
    RecordVideo,         // –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∏–¥–µ–æ
    UploadVideo,         // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤–∏–¥–µ–æ (—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º)
    RecordVoice,         // –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ
    UploadVoice,         // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ (—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º)
    RecordRound,         // –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ
    UploadRound,         // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ (—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º)
    UploadPhoto,         // –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ (—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º)
    UploadFile,          // –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª (—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º)
    ChooseLocation,      // –í—ã–±–∏—Ä–∞–µ—Ç –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
    ChooseContact,       // –í—ã–±–∏—Ä–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç
    ChooseSticker,       // –í—ã–±–∏—Ä–∞–µ—Ç —Å—Ç–∏–∫–µ—Ä
    PlayGame,            // –ò–≥—Ä–∞–µ—Ç –≤ –∏–≥—Ä—É
    Speaking,            // –ì–æ–≤–æ—Ä–∏—Ç –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º –∑–≤–æ–Ω–∫–µ
};
```

---

## –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤

### –¢–∞–π–º–∞—É—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

**–§–∞–π–ª:** `history/view/controls/history_view_compose_controls.cpp:99-101`

```cpp
constexpr auto kSaveDraftTimeout = crl::time(1000);           // 1 —Å–µ–∫
constexpr auto kSaveDraftAnywayTimeout = 5 * crl::time(1000); // 5 —Å–µ–∫
constexpr auto kSaveCloudDraftIdleTimeout = 14 * crl::time(1000); // 14 —Å–µ–∫
```

### –õ–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

**–§–∞–π–ª:** `history/view/controls/history_view_compose_controls.cpp:1932-1943`

```cpp
void ComposeControls::saveDraft(bool delayed) {
    if (delayed) {
        const auto now = crl::now();
        if (!_saveDraftStart) {
            _saveDraftStart = now;
            return _saveDraftTimer.callOnce(kSaveDraftTimeout);  // –ñ–¥–µ–º 1 —Å–µ–∫
        } else if (now - _saveDraftStart < kSaveDraftAnywayTimeout) {
            return _saveDraftTimer.callOnce(kSaveDraftTimeout);  // –ñ–¥–µ–º –µ—â–µ 1 —Å–µ–∫
        }
        // –ü—Ä–æ—à–ª–æ > 5 —Å–µ–∫ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
    }
    writeDrafts();  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
}
```

#### –ê–ª–≥–æ—Ä–∏—Ç–º:

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç
         ‚Üì
   fieldChanged()
         ‚Üì
   saveDraft(delayed=true)
         ‚Üì
    _saveDraftStart = now
         ‚Üì
   –¢–∞–π–º–µ—Ä 1 —Å–µ–∫
         ‚Üì
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚Üì           ‚Üì
–ü–µ—á–∞—Ç–∞–µ—Ç?   –ù–µ—Ç
   ‚Üì           ‚Üì
–°–±—Ä–æ—Å      –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
—Ç–∞–π–º–µ—Ä–∞    –ª–æ–∫–∞–ª—å–Ω–æ
   ‚Üì
–ü—Ä–æ—à–ª–æ > 5 —Å–µ–∫?
   ‚Üì
  –î–∞ ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
```

### writeDrafts()

**–§–∞–π–ª:** `history/view/controls/history_view_compose_controls.cpp:2000-2017`

```cpp
void ComposeControls::writeDrafts() {
    const auto save = (_history != nullptr)
        && (_saveDraftStart > 0)
        && (draftKeyCurrent() != Data::DraftKey::None());
    _saveDraftStart = 0;
    _saveDraftTimer.cancel();

    if (save) {
        if (_saveDraftText) {
            writeDraftTexts();  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç
        }
        writeDraftCursors();    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
    }
    _saveDraftText = false;

    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±–ª–∞—á–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    if (!isEditingMessage() && !_inlineBot) {
        _saveCloudDraftTimer.callOnce(kSaveCloudDraftIdleTimeout);  // 14 —Å–µ–∫
    }
}
```

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î

**–§–∞–π–ª:** `storage/storage_account.cpp:1262-1307`

```cpp
void Account::writeDrafts(not_null<History*> history) {
    const auto peerId = history->peer->id;
    const auto &map = history->draftsMap();
    const auto supportMode = history->session().supportMode();
    const auto sourcesIt = _draftSources.find(history);
    const auto &sources = (sourcesIt != _draftSources.end())
        ? sourcesIt->second
        : EmptyMessageDraftSources();

    auto count = 0;
    EnumerateDrafts(
        map,
        sources,
        supportMode,
        [&](Data::DraftKey key, const Storage::MessageDraft &draft) {
            // –°–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫
            writeDraft(peerId, key, draft);
            ++count;
        });

    if (!count) {
        clearDrafts(peerId);  // –£–¥–∞–ª—è–µ–º –≤—Å–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    }
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ MessageDraft –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è

**–§–∞–π–ª:** `storage/storage_account.h`

```cpp
struct MessageDraft {
    FullReplyTo reply;              // –û—Ç–≤–µ—Ç/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    SuggestPostOptions suggest;     // –û–ø—Ü–∏–∏ –ø–æ—Å—Ç–∞
    TextWithTags textWithTags;      // –¢–µ–∫—Å—Ç —Å —Ç–µ–≥–∞–º–∏
    Data::WebPageDraft webpage;     // –í–µ–±-–ø—Ä–µ–≤—å—é
};

struct MessageDraftSource {
    Fn<MessageDraft()> draft;       // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞
    Fn<MessageCursor()> cursor;     // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞
};
```

---

## –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞–∫–æ–º

### –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–§–∞–π–ª:** `apiwrap.cpp:1938-1943`

```cpp
void ApiWrap::saveDraftToCloudDelayed(not_null<Data::Thread*> thread) {
    _draftsSaveRequestIds.emplace(base::make_weak(thread), 0);
    if (!_draftsSaveTimer.isActive()) {
        _draftsSaveTimer.callOnce(kSaveCloudDraftTimeout);  // 1 —Å–µ–∫
    }
}
```

**–¢–∞–π–º–∞—É—Ç:** `kSaveCloudDraftTimeout = 1000` –º—Å (1 —Å–µ–∫—É–Ω–¥–∞)

### –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

**–§–∞–π–ª:** `apiwrap.cpp:2138-2251`

```cpp
void ApiWrap::saveDraftsToCloud() {
    for (auto i = begin(_draftsSaveRequestIds); i != end(_draftsSaveRequestIds);) {
        const auto weak = i->first;
        const auto thread = weak.get();
        if (!thread) {
            i = _draftsSaveRequestIds.erase(i);
            continue;
        } else if (i->second) {
            ++i;
            continue; // sent already
        }

        const auto history = thread->owningHistory();
        const auto topicRootId = thread->topicRootId();
        const auto monoforumPeerId = thread->monoforumPeerId();

        // –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫
        auto localDraft = history->localDraft(topicRootId, monoforumPeerId);

        // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–∞—á–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫
        auto cloudDraft = history->createCloudDraft(
            topicRootId,
            monoforumPeerId,
            localDraft);

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–ª–∞–≥–∏
        auto flags = MTPmessages_SaveDraft::Flags(0);
        auto &textWithTags = cloudDraft->textWithTags;

        if (cloudDraft->webpage.removed) {
            flags |= MTPmessages_SaveDraft::Flag::f_no_webpage;
        } else if (!cloudDraft->webpage.url.isEmpty()) {
            flags |= MTPmessages_SaveDraft::Flag::f_media;
        }
        if (cloudDraft->reply.messageId
            || cloudDraft->reply.topicRootId
            || cloudDraft->reply.monoforumPeerId) {
            flags |= MTPmessages_SaveDraft::Flag::f_reply_to;
        }
        if (!textWithTags.tags.isEmpty()) {
            flags |= MTPmessages_SaveDraft::Flag::f_entities;
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–≥–∏ –≤ entities
        auto entities = Api::EntitiesToMTP(
            _session,
            TextUtilities::ConvertTextTagsToEntities(textWithTags.tags),
            Api::ConvertOption::SkipLocal);

        history->startSavingCloudDraft(topicRootId, monoforumPeerId);

        // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ù–ê –°–ï–†–í–ï–†
        cloudDraft->saveRequestId = request(MTPmessages_SaveDraft(
            MTP_flags(flags),
            ReplyToForMTP(history, cloudDraft->reply),  // reply_to
            history->peer->input,                       // peer
            MTP_string(textWithTags.text),              // message (—Ç–µ–∫—Å—Ç)
            entities,                                    // entities (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
            Data::WebPageForMTP(                        // media (–≤–µ–±-–ø—Ä–µ–≤—å—é)
                cloudDraft->webpage,
                textWithTags.text.isEmpty()),
            MTP_long(0),                                // effect
            Api::SuggestToMTP(cloudDraft->suggest)      // suggested_post
        )).done([=](const MTPBool &result, const MTP::Response &response) {
            // –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
            history->finishSavingCloudDraft(
                topicRootId,
                monoforumPeerId,
                Api::UnixtimeFromMsgId(response.outerMsgId));
            // ...
        }).fail([=](const MTP::Error &error, const MTP::Response &response) {
            // –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            history->clearCloudDraft(topicRootId, monoforumPeerId);
            // ...
        }).send();

        i->second = cloudDraft->saveRequestId;
        ++i;
    }
}
```

### MTP –º–µ—Ç–æ–¥: messages.saveDraft

**–°—Ö–µ–º–∞:** `mtproto/scheme/api.tl:2305`

```
messages.saveDraft#54ae308e
    flags:#
    no_webpage:flags.1?true          ‚Üê –û—Ç–∫–ª—é—á–∏—Ç—å –≤–µ–±-–ø—Ä–µ–≤—å—é
    invert_media:flags.6?true        ‚Üê –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ–¥–∏–∞
    reply_to:flags.4?InputReplyTo    ‚Üê –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
    peer:InputPeer                   ‚Üê –ö–æ–º—É
    message:string                   ‚Üê –¢–µ–∫—Å—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–∞
    entities:flags.3?Vector<MessageEntity>  ‚Üê –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    media:flags.5?InputMedia         ‚Üê –ú–µ–¥–∏–∞ (–≤–µ–±-–ø—Ä–µ–≤—å—é)
    effect:flags.7?long              ‚Üê –≠—Ñ—Ñ–µ–∫—Ç
    suggested_post:flags.8?SuggestedPost    ‚Üê –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –ø–æ—Å—Ç
= Bool;
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```
messages.saveDraft
    flags: 8 (entities present)
    peer: inputPeerUser {
        user_id: 123456789
        access_hash: 0x...
    }
    message: "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?"
    entities: [
        messageEntityBold {
            offset: 0
            length: 6
        }
    ]
```

### –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ–±–ª–∞–∫–æ?

‚úÖ **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:**
- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤, —Å—Å—ã–ª–∫–∏, —É–ø–æ–º–∏–Ω–∞–Ω–∏—è)
- ID —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–≤–µ—á–∞–µ–º
- ID —Ç–µ–º—ã/—Ç–æ–ø–∏–∫–∞ (–¥–ª—è —Ñ–æ—Ä—É–º–æ–≤)
- –í–µ–±-–ø—Ä–µ–≤—å—é (URL –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
- –û–ø—Ü–∏–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–≥–æ –ø–æ—Å—Ç–∞ (–¥–ª—è –∫–∞–Ω–∞–ª–æ–≤)

‚ùå **–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:**
- –ü–æ–∑–∏—Ü–∏—è –∫—É—Ä—Å–æ—Ä–∞ (—Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ)
- –ò—Å—Ç–æ—Ä–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ß–µ—Ä–Ω–æ–≤–∏–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (edit drafts)

### –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

**–§–∞–π–ª:** `history/history.cpp:376-406`

```cpp
bool History::skipCloudDraftUpdate(
        MsgId topicRootId,
        PeerId monoforumPeerId,
        TimeId date) const {
    const auto key = Data::DraftKey::Local(topicRootId, monoforumPeerId);
    const auto i = _acceptCloudDraftsAfter.find(key);
    return _savingCloudDraftRequests.contains(key)  // –°–µ–π—á–∞—Å —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        || (i != _acceptCloudDraftsAfter.end() && date < i->second);  // –°—Ç–∞—Ä—ã–π
}

void History::startSavingCloudDraft(
        MsgId topicRootId,
        PeerId monoforumPeerId) {
    const auto key = Data::DraftKey::Local(topicRootId, monoforumPeerId);
    ++_savingCloudDraftRequests[key];  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
}

void History::finishSavingCloudDraft(
        MsgId topicRootId,
        PeerId monoforumPeerId,
        TimeId savedAt) {
    const auto key = Data::DraftKey::Local(topicRootId, monoforumPeerId);
    const auto i = _savingCloudDraftRequests.find(key);
    if (i != _savingCloudDraftRequests.end()) {
        if (--i->second <= 0) {
            _savingCloudDraftRequests.erase(i);
        }
    }
    // –ù–µ –ø—Ä–∏–Ω–∏–º–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫–∏ —Å—Ç–∞—Ä—à–µ savedAt + 2 —Å–µ–∫
    auto &after = _acceptCloudDraftsAfter[key];
    after = std::max(after, savedAt + kSkipCloudDraftsFor);  // +2 —Å–µ–∫
}
```

**–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞:** `kSkipCloudDraftsFor = TimeId(2)` (2 —Å–µ–∫—É–Ω–¥—ã)

#### –õ–æ–≥–∏–∫–∞:

1. –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `startSavingCloudDraft()`
2. –í–æ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ `skipCloudDraftUpdate()` –≤–µ—Ä–Ω–µ—Ç `true`
3. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `finishSavingCloudDraft()`
4. –ß–µ—Ä–Ω–æ–≤–∏–∫–∏ —Å `date < savedAt + 2 —Å–µ–∫` –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è

---

## –ü–æ–ª—É—á–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞

### Update –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞

**–°—Ö–µ–º–∞:** `mtproto/scheme/api.tl:344`

```
updateDraftMessage#edfc111e
    flags:#
    peer:Peer                        ‚Üê –û—Ç –∫–æ–≥–æ
    top_msg_id:flags.0?int          ‚Üê ID —Ç–µ–º—ã/—Ç–æ–ø–∏–∫–∞
    saved_peer_id:flags.1?Peer      ‚Üê ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
    draft:DraftMessage               ‚Üê –ß–µ—Ä–Ω–æ–≤–∏–∫
= Update;
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ update

**–§–∞–π–ª:** `api/api_updates.cpp:2710-2726`

```cpp
case mtpc_updateDraftMessage: {
    const auto &data = update.c_updateDraftMessage();
    const auto peerId = peerFromMTP(data.vpeer());
    const auto topicRootId = data.vtop_msg_id().value_or_empty();
    const auto monoforumPeerId = data.vsaved_peer_id()
        ? peerFromMTP(*data.vsaved_peer_id())
        : PeerId();

    data.vdraft().match([&](const MTPDdraftMessage &data) {
        Data::ApplyPeerCloudDraft(&session(), peerId, topicRootId, monoforumPeerId, data);
    }, [&](const MTPDdraftMessageEmpty &data) {
        Data::ClearPeerCloudDraft(&session(), peerId, topicRootId, monoforumPeerId, data.vdate().value_or_empty());
    });
} break;
```

### ApplyPeerCloudDraft

**–§–∞–π–ª:** `data/data_drafts.cpp:73-135`

```cpp
void ApplyPeerCloudDraft(
        not_null<Main::Session*> session,
        PeerId peerId,
        MsgId topicRootId,
        PeerId monoforumPeerId,
        const MTPDdraftMessage &draft) {
    const auto history = session->data().history(peerId);
    const auto date = draft.vdate().v;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ª–∏ –º—ã —ç—Ç–æ—Ç update
    if (history->skipCloudDraftUpdate(topicRootId, monoforumPeerId, date)) {
        return;
    }

    // –ü–∞—Ä—Å–∏–º —Ç–µ–∫—Å—Ç —Å entities
    const auto textWithTags = TextWithTags{
        qs(draft.vmessage()),
        TextUtilities::ConvertEntitiesToTextTags(
            Api::EntitiesFromMTP(
                session,
                draft.ventities().value_or_empty()))
    };

    // –ü–∞—Ä—Å–∏–º reply
    auto replyTo = draft.vreply_to()
        ? ReplyToFromMTP(history, *draft.vreply_to())
        : FullReplyTo();
    replyTo.topicRootId = topicRootId;
    replyTo.monoforumPeerId = monoforumPeerId;

    // –ü–∞—Ä—Å–∏–º webpage
    auto webpage = WebPageDraft{
        .invert = draft.is_invert_media(),
        .removed = draft.is_no_webpage(),
    };
    if (const auto media = draft.vmedia()) {
        media->match([&](const MTPDmessageMediaWebPage &data) {
            const auto parsed = session->data().processWebpage(data.vwebpage());
            if (!parsed->failed) {
                webpage.forceLargeMedia = data.is_force_large_media();
                webpage.forceSmallMedia = data.is_force_small_media();
                webpage.manual = data.is_manual();
                webpage.url = parsed->url;
                webpage.id = parsed->id;
            }
        }, [](const auto &) {});
    }

    // –°–æ–∑–¥–∞–µ–º –æ–±–ª–∞—á–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫
    auto cloudDraft = std::make_unique<Draft>(
        textWithTags,
        replyTo,
        suggest,
        MessageCursor(Ui::kQFixedMax, Ui::kQFixedMax, Ui::kQFixedMax),
        std::move(webpage));
    cloudDraft->date = date;

    history->setCloudDraft(std::move(cloudDraft));
    history->applyCloudDraft(topicRootId, monoforumPeerId);
}
```

### applyCloudDraft

**–§–∞–π–ª:** `history/history.cpp:408-431`

```cpp
void History::applyCloudDraft(MsgId topicRootId, PeerId monoforumPeerId) {
    if (!topicRootId && session().supportMode()) {
        updateChatListEntry();
        session().supportHelper().cloudDraftChanged(this);
    } else {
        createLocalDraftFromCloud(topicRootId, monoforumPeerId);  // –ö–æ–ø–∏—Ä—É–µ–º –≤ local
        if (const auto thread = threadFor(topicRootId, monoforumPeerId)) {
            thread->updateChatListSortPosition();
            if (topicRootId) {
                session().changes().topicUpdated(
                    thread->asTopic(),
                    Data::TopicUpdate::Flag::CloudDraft);
            } else if (monoforumPeerId) {
                session().changes().sublistUpdated(
                    thread->asSublist(),
                    Data::SublistUpdate::Flag::CloudDraft);
            } else {
                session().changes().historyUpdated(
                    this,
                    UpdateFlag::CloudDraft);
            }
        }
    }
}
```

### createLocalDraftFromCloud

**–§–∞–π–ª:** `history/history.cpp:232-269`

```cpp
void History::createLocalDraftFromCloud(
        MsgId topicRootId,
        PeerId monoforumPeerId) {
    const auto draft = cloudDraft(topicRootId, monoforumPeerId);
    if (!draft) {
        clearLocalDraft(topicRootId, monoforumPeerId);
        return;
    } else if (Data::DraftIsNull(draft) || !draft->date) {
        return;
    }

    draft->reply.topicRootId = topicRootId;
    draft->reply.monoforumPeerId = monoforumPeerId;

    auto existing = localDraft(topicRootId, monoforumPeerId);

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±–ª–∞—á–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–æ–≤–µ–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ
    if (Data::DraftIsNull(existing)
        || !existing->date
        || draft->date >= existing->date) {
        if (!existing) {
            setLocalDraft(std::make_unique<Data::Draft>(
                draft->textWithTags,
                draft->reply,
                draft->suggest,
                draft->cursor,
                draft->webpage));
            existing = localDraft(topicRootId, monoforumPeerId);
        } else if (existing != draft) {
            existing->textWithTags = draft->textWithTags;
            existing->reply = draft->reply;
            existing->suggest = draft->suggest;
            existing->cursor = draft->cursor;
            existing->webpage = draft->webpage;
        }
        existing->date = draft->date;
    }
}
```

#### –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:

```
–ü–æ–ª—É—á–µ–Ω updateDraftMessage
         ‚Üì
   ApplyPeerCloudDraft()
         ‚Üì
   –ü—Ä–æ–≤–µ—Ä–∫–∞ skipCloudDraftUpdate()
         ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚Üì         ‚Üì
–ü—Ä–æ–ø—É—Å–∫–∞–µ–º  –ü—Ä–∏–º–µ–Ω—è–µ–º
(—Å–æ—Ö—Ä–∞–Ω—è–µ–º  (–ø–∞—Ä—Å–∏–º draft)
—Å–µ–π—á–∞—Å)        ‚Üì
          setCloudDraft()
               ‚Üì
          applyCloudDraft()
               ‚Üì
     createLocalDraftFromCloud()
               ‚Üì
          –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–∞—Ç—ã
               ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚Üì             ‚Üì
   Cloud –Ω–æ–≤–µ–µ   Local –Ω–æ–≤–µ–µ
        ‚Üì             ‚Üì
  –û–±–Ω–æ–≤–ª—è–µ–º     –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º
   Local
```

### –ó–∞–ø—Ä–æ—Å –≤—Å–µ—Ö —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤

**MTP –º–µ—Ç–æ–¥:** `messages.getAllDrafts#6a3f8d65 = Updates;`

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤.

---

## Streamed Drafts

> **–ù–æ–≤–∞—è —Ñ–∏—á–∞:** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç –¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### –ß—Ç–æ —ç—Ç–æ?

**Streamed Drafts** ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞ (draft) –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≥–æ, —á—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫.

### MTP Action: sendMessageTextDraftAction

**–°—Ö–µ–º–∞:** `mtproto/scheme/api.tl:541`

```
sendMessageTextDraftAction#376d975c
    random_id:long          ‚Üê ID —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    text:TextWithEntities   ‚Üê –¢–ï–ö–°–¢ –ß–ï–†–ù–û–í–ò–ö–ê (!)
= SendMessageAction;
```

**–í–∞–∂–Ω–æ:** –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ `typing`, –∑–¥–µ—Å—å **–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–∞–º —Ç–µ–∫—Å—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–∞**!

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ streamed draft

**–§–∞–π–ª:** `api/api_updates.cpp:1115-1118`

```cpp
} else if (action.type() == mtpc_sendMessageTextDraftAction) {
    const auto &data = action.c_sendMessageTextDraftAction();
    history->streamedDrafts().apply(rootId, fromId, when, data);
    return;
}
```

### HistoryStreamedDrafts::apply

**–§–∞–π–ª:** `history/history_streamed_drafts.cpp:33-70`

```cpp
void HistoryStreamedDrafts::apply(
        MsgId rootId,
        PeerId fromId,
        TimeId when,
        const MTPDsendMessageTextDraftAction &data) {
    if (!rootId) {
        rootId = Data::ForumTopic::kGeneralId;
    }
    if (!when) {
        clear(rootId);  // –û—Ç–º–µ–Ω–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
        return;
    }

    // –ü–∞—Ä—Å–∏–º —Ç–µ–∫—Å—Ç —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    const auto text = Api::ParseTextWithEntities(
        &_history->session(),
        data.vtext());
    const auto randomId = data.vrandom_id().v;

    // –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–µ—Ä–Ω–æ–≤–∏–∫
    if (update(rootId, randomId, text)) {
        return;
    }

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞
    clear(rootId);
    _drafts.emplace(rootId, Draft{
        .message = _history->addNewLocalMessage({
            .id = _history->owner().nextLocalMessageId(),
            .flags = MessageFlag::Local | MessageFlag::HasReplyInfo,
            .from = fromId,
            .replyTo = {
                .messageId = { _history->peer->id, rootId },
                .topicRootId = rootId,
            },
            .date = when,
        }, text, MTP_messageMediaEmpty()),
        .randomId = randomId,
        .updated = crl::now(),
    });

    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ—á–∏—Å—Ç–∫–∏ —á–µ—Ä–µ–∑ 30 —Å–µ–∫
    if (!_checkTimer.isActive()) {
        _checkTimer.callOnce(kClearTimeout);  // 30 —Å–µ–∫
    }
}
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ streamed draft

**–§–∞–π–ª:** `history/history_streamed_drafts.cpp:72-83`

```cpp
bool HistoryStreamedDrafts::update(
        MsgId rootId,
        uint64 randomId,
        const TextWithEntities &text) {
    const auto i = _drafts.find(rootId);
    if (i == end(_drafts) || i->second.randomId != randomId) {
        return false;  // –î—Ä—É–≥–æ–π —á–µ—Ä–Ω–æ–≤–∏–∫ –∏–ª–∏ –Ω–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–∞
    }
    i->second.message->setText(text);  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
    i->second.updated = crl::now();     // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
    return true;
}
```

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö streamed drafts

**–§–∞–π–ª:** `history/history_streamed_drafts.cpp:105-124`

```cpp
void HistoryStreamedDrafts::check() {
    auto closest = crl::time();
    const auto now = crl::now();
    for (auto i = begin(_drafts); i != end(_drafts);) {
        if (now - i->second.updated >= kClearTimeout) {  // 30 —Å–µ–∫
            i->second.message->destroy();
            i = _drafts.erase(i);
        } else {
            if (!closest || closest > i->second.updated) {
                closest = i->second.updated;
            }
            ++i;
        }
    }
    if (closest) {
        _checkTimer.callOnce(kClearTimeout - (now - closest));
    } else {
        scheduleDestroy();  // –í—Å–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∏ —É–¥–∞–ª–µ–Ω—ã
    }
}
```

**–¢–∞–π–º–∞—É—Ç:** `kClearTimeout = 30 * crl::time(1000)` (30 —Å–µ–∫—É–Ω–¥)

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI

Streamed draft –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞. –û–Ω–æ:
- –ò–º–µ–µ—Ç —Ñ–ª–∞–≥ `MessageFlag::Local`
- –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ –∏–ª–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

### –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è

**–§–∞–π–ª:** `history/history_streamed_drafts.cpp:96-103`

```cpp
void HistoryStreamedDrafts::applyItemAdded(not_null<HistoryItem*> item) {
    const auto rootId = item->topicRootId();
    const auto i = _drafts.find(rootId);
    if (i == end(_drafts) || i->second.message->from() != item->from()) {
        return;
    }
    clear(rootId);  // –£–¥–∞–ª—è–µ–º streamed draft
}
```

---

## –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã

### –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤

| –î–µ–π—Å—Ç–≤–∏–µ | –ò–Ω—Ç–µ—Ä–≤–∞–ª | –§–∞–π–ª | –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ |
|----------|----------|------|-----------|
| **–û—Ç–ø—Ä–∞–≤–∫–∞ typing** | –ö–∞–∂–¥—ã–µ **5 —Å–µ–∫** | `api/api_send_progress.cpp:23` | `kSendMyTypingInterval` |
| **–û—Ç–º–µ–Ω–∞ typing** | –ß–µ—Ä–µ–∑ **5 —Å–µ–∫** | `api/api_send_progress.cpp:21` | `kCancelTypingActionTimeout` |
| **–õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ)** | **1 —Å–µ–∫** | `history/view/controls/history_view_compose_controls.cpp:99` | `kSaveDraftTimeout` |
| **–õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ)** | **5 —Å–µ–∫** | `history/view/controls/history_view_compose_controls.cpp:100` | `kSaveDraftAnywayTimeout` |
| **–ó–∞–ø—É—Å–∫ –æ–±–ª–∞—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏** | **14 —Å–µ–∫** –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è | `history/view/controls/history_view_compose_controls.cpp:101` | `kSaveCloudDraftIdleTimeout` |
| **–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–∑–∞–¥–µ—Ä–∂–∫–∞)** | **1 —Å–µ–∫** | `apiwrap.cpp:95` | `kSaveCloudDraftTimeout` |
| **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö cloud drafts** | **2 —Å–µ–∫** | `history/history.cpp:80` | `kSkipCloudDraftsFor` |
| **Typing –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** | –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –µ—Å–ª–∏ > **30 —Å–µ–∫** | `api/api_send_progress.cpp:24` | `kSendTypingsToOfflineFor` |
| **–û—á–∏—Å—Ç–∫–∞ streamed drafts** | **30 —Å–µ–∫** | `history/history_streamed_drafts.cpp:18` | `kClearTimeout` |

### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤

```
–í—Ä–µ–º—è ‚Üí
0s    1s    2s    3s    4s    5s    6s    7s    8s    9s    10s   11s   12s   13s   14s   15s

–ü–µ—á–∞—Ç—å: ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº
        ‚Üì     ‚Üì     ‚Üì     ‚Üì     ‚Üì                                                       ‚Üì
Typing: ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚óè  (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫)                                      ‚äó –æ—Ç–º–µ–Ω–∞

Local:  ‚óè‚îÄ‚îÄ‚îÄ‚Üí‚óè     ‚óè‚îÄ‚îÄ‚îÄ‚Üí‚óè     ‚óè‚îÄ‚îÄ‚îÄ‚Üí‚óè     (–æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ 1 —Å–µ–∫, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ 5 —Å–µ–∫)

Cloud:  ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí‚óè
        (–∂–¥–µ–º 14 —Å–µ–∫ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
```

---

## –î–∏–∞–≥—Ä–∞–º–º—ã

### 1. –ü–æ–ª–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —á–µ—Ä–Ω–æ–≤–∏–∫–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å    ‚îÇ
‚îÇ –ø–µ—á–∞—Ç–∞–µ—Ç —Ç–µ–∫—Å—Ç  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ComposeControls::fieldChanged()                ‚îÇ
‚îÇ - –û–±–Ω–æ–≤–ª—è–µ—Ç UI                                 ‚îÇ
‚îÇ - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç typing (–µ—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã)  ‚îÇ
‚îÇ - –ó–∞–ø—É—Å–∫–∞–µ—Ç saveDraft(delayed=true)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚Üì         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Typing   ‚îÇ  ‚îÇ saveDraft(delayed=true)          ‚îÇ
‚îÇ –∫–∞–∂–¥—ã–µ   ‚îÇ  ‚îÇ - –ñ–¥–µ—Ç 1 —Å–µ–∫                     ‚îÇ
‚îÇ 5 —Å–µ–∫    ‚îÇ  ‚îÇ - –ò–ª–∏ 5 —Å–µ–∫ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ writeDrafts()       ‚îÇ
              ‚îÇ - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç   ‚îÇ
              ‚îÇ - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—É—Ä—Å–æ—Ä  ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ storage::Account::writeDrafts() ‚îÇ
              ‚îÇ - –ó–∞–ø–∏—Å–∞—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î       ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ _saveCloudDraftTimer.callOnce(14s)‚îÇ
              ‚îÇ - –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –æ–±–ª–∞—á–Ω–æ–µ          ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì (—á–µ—Ä–µ–∑ 14 —Å–µ–∫)
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ ApiWrap::saveCurrentDraft   ‚îÇ
              ‚îÇ ToCloud()                   ‚îÇ
              ‚îÇ - –ù–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç        ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ ApiWrap::saveDraftToCloud   ‚îÇ
              ‚îÇ Delayed()                   ‚îÇ
              ‚îÇ - –î–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å        ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì (—á–µ—Ä–µ–∑ 1 —Å–µ–∫)
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ ApiWrap::saveDraftsToCloud()‚îÇ
              ‚îÇ - –°–æ–∑–¥–∞—Ç—å cloudDraft        ‚îÇ
              ‚îÇ - –û—Ç–ø—Ä–∞–≤–∏—Ç—å MTP –∑–∞–ø—Ä–æ—Å      ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ messages.saveDraft          ‚îÇ
              ‚îÇ   peer: ...                 ‚îÇ
              ‚îÇ   message: "—Ç–µ–∫—Å—Ç"          ‚îÇ
              ‚îÇ   entities: [...]           ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ –°–µ—Ä–≤–µ—Ä Telegram             ‚îÇ
              ‚îÇ - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫        ‚îÇ
              ‚îÇ - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥—Ä—É–≥–∏–º         ‚îÇ
              ‚îÇ   —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º               ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°–µ—Ä–≤–µ—Ä Telegram     ‚îÇ
‚îÇ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç update   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ updateDraftMessage               ‚îÇ
‚îÇ   peer: ...                      ‚îÇ
‚îÇ   draft:                         ‚îÇ
‚îÇ     message: "—Ç–µ–∫—Å—Ç"             ‚îÇ
‚îÇ     entities: [...]              ‚îÇ
‚îÇ     date: 1234567890             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Api::Updates::applyUpdates()     ‚îÇ
‚îÇ - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç update            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Data::ApplyPeerCloudDraft()      ‚îÇ
‚îÇ - –ü–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç, entities         ‚îÇ
‚îÇ - –ü–∞—Ä—Å–∏—Ç reply, webpage          ‚îÇ
‚îÇ - –°–æ–∑–¥–∞–µ—Ç cloudDraft             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ history->skipCloudDraftUpdate()? ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚Üì             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –î–∞      ‚îÇ  ‚îÇ –ù–µ—Ç                    ‚îÇ
‚îÇ (–∏–≥–Ω–æ—Ä) ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ history->setCloudDraft() ‚îÇ
              ‚îÇ - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–ª–∞—á–Ω—ã–π     ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ history->applyCloudDraft()‚îÇ
              ‚îÇ - –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ UI         ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ createLocalDraftFromCloud()‚îÇ
              ‚îÇ - –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ localDraft  ‚îÇ
              ‚îÇ - –°—Ä–∞–≤–Ω–∏—Ç—å –¥–∞—Ç—ã            ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ UI –æ–±–Ω–æ–≤–ª–µ–Ω                ‚îÇ
              ‚îÇ –ß–µ—Ä–Ω–æ–≤–∏–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω          ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3. Streamed Draft (–°–æ–≤–º–µ—Å—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A      ‚îÇ
‚îÇ –ø–µ—á–∞—Ç–∞–µ—Ç "–ü—Ä–∏–≤–µ—Ç"   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ messages.setTyping               ‚îÇ
‚îÇ   action: sendMessageTextDraft   ‚îÇ
‚îÇ     Action {                     ‚îÇ
‚îÇ       random_id: 12345           ‚îÇ
‚îÇ       text: "–ü—Ä–∏–≤–µ—Ç"             ‚îÇ
‚îÇ     }                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°–µ—Ä–≤–µ—Ä Telegram                  ‚îÇ
‚îÇ - –ü–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B –ø–æ–ª—É—á–∞–µ—Ç update   ‚îÇ
‚îÇ updateUserTyping:                ‚îÇ
‚îÇ   action: sendMessageTextDraft   ‚îÇ
‚îÇ     Action                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Api::Updates::handleSendAction   ‚îÇ
‚îÇ Update()                         ‚îÇ
‚îÇ - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∏–ø action           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ history->streamedDrafts().apply()‚îÇ
‚îÇ - random_id: 12345               ‚îÇ
‚îÇ - text: "–ü—Ä–∏–≤–µ—Ç"                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚Üì             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°—É—â–µ—Å—Ç–≤—É–µ—Ç? ‚îÇ  ‚îÇ –ù–µ—Ç                     ‚îÇ
‚îÇ –î–∞          ‚îÇ  ‚îÇ - –°–æ–∑–¥–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ     ‚îÇ
‚îÇ - –û–±–Ω–æ–≤–∏—Ç—å  ‚îÇ  ‚îÇ   —Å–æ–æ–±—â–µ–Ω–∏–µ             ‚îÇ
‚îÇ   —Ç–µ–∫—Å—Ç     ‚îÇ  ‚îÇ - –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≤ —á–∞—Ç–µ     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ –¢–∞–π–º–µ—Ä 30 —Å–µ–∫              ‚îÇ
              ‚îÇ - –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞   ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 4. –ü—Ä–æ—Ü–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ typing

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ _sendActionUpdates.fire(        ‚îÇ
‚îÇ   { Api::SendProgressType::     ‚îÇ
‚îÇ     Typing })                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SendProgressManager::update()   ‚îÇ
‚îÇ - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ (5 —Å–µ–∫)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚Üì         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°–ª–∏—à–∫–æ–º     ‚îÇ  ‚îÇ –ü—Ä–æ—à–ª–æ >= 5 —Å–µ–∫      ‚îÇ
‚îÇ —Ä–∞–Ω–æ        ‚îÇ  ‚îÇ                      ‚îÇ
‚îÇ (skip)      ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ SendProgressManager::    ‚îÇ
              ‚îÇ send()                   ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ skipRequest()?           ‚îÇ
              ‚îÇ - isSelf?                ‚îÇ
              ‚îÇ - isBot?                 ‚îÇ
              ‚îÇ - isOffline > 30s?       ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚Üì               ‚Üì
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ –î–∞ (skip)   ‚îÇ  ‚îÇ –ù–µ—Ç              ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚Üì
                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                      ‚îÇ MTPmessages_SetTyping( ‚îÇ
                      ‚îÇ   peer: ...,           ‚îÇ
                      ‚îÇ   action: typing       ‚îÇ
                      ‚îÇ )                      ‚îÇ
                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚Üì
                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                      ‚îÇ –°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç        ‚îÇ
                      ‚îÇ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥–∏–º      ‚îÇ
                      ‚îÇ "User is typing..."    ‚îÇ
                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

### –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:

| –ú–µ—Ö–∞–Ω–∏–∑–º | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ | –ö–æ–≥–¥–∞ | –ò–Ω—Ç–µ—Ä–≤–∞–ª |
|----------|-----------|-------|----------|
| **Typing indicator** | ‚ùå –¢–æ–ª—å–∫–æ —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è (typing) | –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ | –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫ |
| **Local draft** | ‚úÖ –í–µ—Å—å —Ç–µ–∫—Å—Ç + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ | 1-5 —Å–µ–∫ (–ª–æ–∫–∞–ª—å–Ω–æ) |
| **Cloud draft** | ‚úÖ –í–µ—Å—å —Ç–µ–∫—Å—Ç + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ + reply + webpage | –ü–æ—Å–ª–µ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è –ø–µ—á–∞—Ç–∏ | 14 —Å–µ–∫ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è |
| **Streamed draft** | ‚úÖ –í–µ—Å—å —Ç–µ–∫—Å—Ç + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ collaborative editing | –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ |

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

1. **Typing indicator –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç** ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç –ø–µ—á–∞—Ç–∏
2. **Cloud drafts –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ä–µ–¥–∫–æ** ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ 14 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. **Streamed drafts** ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ñ–∏—á–∞, —Ç—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

1. **–õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** ‚Äî –±—ã—Å—Ç—Ä–æ–µ (1-5 —Å–µ–∫), –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI
2. **–û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** ‚Äî –æ—Ç–ª–æ–∂–µ–Ω–Ω–∞—è (14 —Å–µ–∫), —ç–∫–æ–Ω–æ–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫
3. **Typing indicator** ‚Äî –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω (5 —Å–µ–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª, –ø—Ä–æ–ø—É—Å–∫ –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω)

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏:

1. –ß–µ—Ä–Ω–æ–≤–∏–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ –æ–±–ª–∞–∫–æ
2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–∞ timestamp –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
3. –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–µ—Ä–µ–¥ –æ–±–ª–∞—á–Ω—ã–º–∏ (–µ—Å–ª–∏ –Ω–æ–≤–µ–µ)

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–ê–Ω–∞–ª–∏–∑ Typing Indicator](./typing_indicator_analysis.md) ‚Äî –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç"
- [–û–±—Ä–∞–±–æ—Ç–∫–∞ Ctrl+V](./ctrl_v_handling.md) ‚Äî –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å—Ç–∞–≤–∫–∞ –∏–∑ –±—É—Ñ–µ—Ä–∞
- [–û–±—Ä–∞–±–æ—Ç–∫–∞ Ctrl+C](./ctrl_c_handling.md) ‚Äî –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä

---

