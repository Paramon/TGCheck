# –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –∏ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram Desktop

## üìã –ö–†–ê–¢–ö–ò–ô –í–´–í–û–î

### ‚úÖ –ß—Ç–æ –°–û–ë–ò–†–ê–ï–¢–°–Ø –∏ –û–¢–ü–†–ê–í–õ–Ø–ï–¢–°–Ø –Ω–∞ —Å–µ—Ä–≤–µ—Ä:

1. **–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** (–ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É):
   - –ú–æ–¥–µ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (Device Model)
   - –í–µ—Ä—Å–∏—è –û–° (System Version)
   - –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (App Version)
   - –Ø–∑—ã–∫–æ–≤—ã–µ –∫–æ–¥—ã (System Language, App Language)
   - –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å (Timezone Offset)
   - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–∫—Å–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

2. **–ö—Ä–∞—à-—Ä–µ–ø–æ—Ä—Ç—ã** (—Ç–æ–ª—å–∫–æ —Å —è–≤–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
   - Minidump —Ñ–∞–π–ª—ã
   - Stack traces
   - –°–∏—Å—Ç–µ–º–Ω—ã–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏
   - –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π** (–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏):
   - –ó–∞–ø—Ä–æ—Å —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
   - –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

### ‚ùå –ß—Ç–æ –ù–ï —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è:

- ‚ùå Google Analytics, Firebase, Amplitude, Mixpanel
- ‚ùå –ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (–∫–ª–∏–∫–∏, –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ–Ω—é)
- ‚ùå Tracking –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- ‚ùå Heatmaps –∏–ª–∏ scroll tracking
- ‚ùå A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚ùå Feature usage analytics
- ‚ùå –ü–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- ‚ùå –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –º–µ–¥–∏–∞
- ‚ùå –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ SDK
- ‚ùå Fingerprinting –±—Ä–∞—É–∑–µ—Ä–∞
- ‚ùå IP-–∞–¥—Ä–µ—Å–∞ (–∫—Ä–æ–º–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)

### üîê –û—Ü–µ–Ω–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏:

**–£—Ä–æ–≤–µ–Ω—å: –í–´–°–û–ö–ò–ô**

- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–∞)
- –ù–µ—Ç —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –ö—Ä–∞—à-—Ä–µ–ø–æ—Ä—Ç—ã —Ç—Ä–µ–±—É—é—Ç —è–≤–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ —à–∏—Ñ—Ä—É—é—Ç—Å—è MTProto –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ
- –ù–µ—Ç —Å–∫—Ä—ã—Ç—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ tracking'–∞

---

## 1. –°–ò–°–¢–ï–ú–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø (MTProto initConnection)

### –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏

**–§–∞–π–ª:** `Telegram/SourceFiles/mtproto/session_private.cpp`
**–ú–µ—Ç–æ–¥:** `SessionPrivate::sendPrepared()`
**–°—Ç—Ä–æ–∫–∏:** 689-726

#### MTProto –∑–∞–ø—Ä–æ—Å initConnection:

```cpp
auto initWrapper = MTPInitConnection<SerializedRequest>(
    MTP_flags(proxyFlags),
    MTP_int(ApiId),                              // API ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    MTP_string(deviceModel),                     // –ú–æ–¥–µ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    MTP_string(systemVersion),                   // –í–µ—Ä—Å–∏—è –û–°
    MTP_string(appVersion),                      // –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    MTP_string(systemLangCode),                  // –°–∏—Å—Ç–µ–º–Ω—ã–π —è–∑—ã–∫ (en-US)
    MTP_string(_instance->langPackName()),       // –Ø–∑—ã–∫–æ–≤–æ–π –ø–∞–∫–µ—Ç ("tdesktop")
    MTP_string(_instance->cloudLangCode()),      // –Ø–∑—ã–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (en)
    clientProxyFields,                           // –ü—Ä–æ–∫—Å–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
    MTP_jsonObject(prepareInitParams()),         // JSON –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (timezone)
    SerializedRequest());
```

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è | –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å? |
|------|----------|-----------------|-----------------|
| **api_id** | ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | `2040` (desktop), `17349` (test) | ‚ùå –ù–µ—Ç |
| **device_model** | –ú–æ–¥–µ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ | `"MacBook Air M1"`, `"ThinkPad X1"` | ‚úÖ –î–∞ (—á–µ—Ä–µ–∑ config) |
| **system_version** | –í–µ—Ä—Å–∏—è –û–° | `"macOS 14.0"`, `"Windows 11 x64"` | ‚úÖ –î–∞ (—á–µ—Ä–µ–∑ config) |
| **app_version** | –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | `"6.2.4 x64"`, `"6.2.4 aarch64 Snap"` | ‚ùå –ù–µ—Ç |
| **system_lang_code** | –Ø–∑—ã–∫ —Å–∏—Å—Ç–µ–º—ã | `"en-US"`, `"ru-RU"`, `"de-DE"` | ‚úÖ –î–∞ (—á–µ—Ä–µ–∑ config) |
| **lang_pack** | –Ø–∑—ã–∫–æ–≤–æ–π –ø–∞–∫–µ—Ç | `"tdesktop"` | ‚úÖ –î–∞ (—á–µ—Ä–µ–∑ config) |
| **lang_code** | –Ø–∑—ã–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | `"en"`, `"ru"`, `"uk"` | ‚úÖ –î–∞ (—á–µ—Ä–µ–∑ config) |
| **params** (JSON) | Timezone –∏ –¥—Ä. | `{"tz_offset": 10800}` | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ |

#### –û—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏:

**CDN —Å–µ—Ä–≤–µ—Ä—ã** (—Å—Ç—Ä–æ–∫–∏ 696-701):
```cpp
if (session->isUsedByCloudCdnSession()) {
    deviceModel = "n/a";
    systemVersion = "n/a";
}
```
–î–ª—è CDN (–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤) —Å–∏—Å—Ç–µ–º–∞ –º–∞—Å–∫–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.

---

### –¢–æ—á–∫–∏ —Å–±–æ—Ä–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

**–§–∞–π–ª:** `Telegram/SourceFiles/main/main_account.cpp`
**–§—É–Ω–∫—Ü–∏—è:** `Account::startMtp()`
**–°—Ç—Ä–æ–∫–∏:** 415-424, 566-567

```cpp
void Account::startMtp(std::unique_ptr<MTP::Config> config) {
    auto fields = MTP::Environment{};
    // ...
    fields.deviceModel = Platform::DeviceModelPretty();      // ‚Üê –ó–¥–µ—Å—å
    fields.systemVersion = Platform::SystemVersionPretty();  // ‚Üê –ò –∑–¥–µ—Å—å
    // ...
}
```

**–•—Ä–∞–Ω–µ–Ω–∏–µ:** `Telegram/SourceFiles/mtproto/mtp_instance.cpp`

```cpp
class Instance::Private {
    QString _deviceModelDefault;  // Device model
    QString _systemVersion;       // System version
    mutable QMutex _mutex;        // Thread safety
};
```

---

## 2. –ü–õ–ê–¢–§–û–†–ú–ï–ù–ù–ê–Ø –î–ï–¢–ï–ö–¶–ò–Ø

### Windows - Device Model

**–§–∞–π–ª:** `Telegram/lib_base/base/platform/win/base_info_win.cpp`
**–§—É–Ω–∫—Ü–∏—è:** `DeviceModelPretty()`
**–°—Ç—Ä–æ–∫–∏:** 154-235

#### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:

**1. Windows Registry (HKEY_LOCAL_MACHINE):**
```
HARDWARE\Description\System\BIOS
‚îú‚îÄ‚îÄ SystemProductName    ‚Üê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1
‚îú‚îÄ‚îÄ SystemFamily         ‚Üê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2
‚îî‚îÄ‚îÄ BaseBoardProduct     ‚Üê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3
```

**–ö–æ–¥ —á—Ç–µ–Ω–∏—è Registry:**
```cpp
const auto readRegistry = [](LPCWSTR path, LPCWSTR key) {
    auto result = QString();
    HKEY rootKey;
    if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, path, 0, KEY_READ, &rootKey) == ERROR_SUCCESS) {
        DWORD size = 0;
        RegQueryValueEx(rootKey, key, 0, nullptr, nullptr, &size);
        if (size > 0) {
            auto buffer = QByteArray(size, Qt::Uninitialized);
            if (RegQueryValueEx(rootKey, key, 0, nullptr,
                reinterpret_cast<LPBYTE>(buffer.data()), &size) == ERROR_SUCCESS) {
                result = QString::fromWCharArray(
                    reinterpret_cast<const wchar_t*>(buffer.constData()));
            }
        }
        RegCloseKey(rootKey);
    }
    return result;
};
```

**2. Fallback –∑–Ω–∞—á–µ–Ω–∏–µ:**
- –ï—Å–ª–∏ Registry –ø—É—Å—Ç: `"Desktop"`

**–ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
- `"HP EliteBook 840 G7"`
- `"ASUS ROG Strix G15"`
- `"Dell Precision 5540"`
- `"Desktop"` (–¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ü–ö)

---

### Windows - System Version

**–§–∞–π–ª:** `Telegram/lib_base/base/platform/win/base_info_win.cpp`
**–§—É–Ω–∫—Ü–∏—è:** `SystemVersionPretty()`
**–°—Ç—Ä–æ–∫–∏:** 237-300

#### –î–µ—Ç–µ–∫—Ü–∏—è –≤–µ—Ä—Å–∏–∏ Windows:

```cpp
QString SystemVersionPretty() {
    auto result = QString("Windows");

    if (IsWindows11OrGreater()) {
        result += " 11";
    } else if (IsWindows10OrGreater()) {
        result += " 10";
    } else if (IsWindows8Point1OrGreater()) {
        result += " 8.1";
    } else if (IsWindows8OrGreater()) {
        result += " 8";
    } else if (IsWindows7OrGreater()) {
        result += " 7";
    }

    // –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
    if (IsARM64()) {
        result += " ARM64";
    } else if (Is64Bit()) {
        result += " x64";
    }

    return result;
}
```

**–§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ—Ä—Å–∏–∏:**
```cpp
bool IsWindows11OrGreater();   // Build 22000+
bool IsWindows10OrGreater();   // Build 10240+
bool IsWindows8Point1OrGreater();
bool IsWindows8OrGreater();
bool IsWindows7OrGreater();
```

**–î–µ—Ç–µ–∫—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**
```cpp
USHORT processMachine = 0;
USHORT nativeMachine = 0;
if (IsWow64Process2(GetCurrentProcess(), &processMachine, &nativeMachine)) {
    if (nativeMachine == IMAGE_FILE_MACHINE_ARM64) {
        return "ARM64";
    } else if (nativeMachine == IMAGE_FILE_MACHINE_AMD64) {
        return "x64";
    }
}
```

**–ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
- `"Windows 11 x64"`
- `"Windows 10 ARM64"`
- `"Windows 8.1"`

---

### Linux - Device Model

**–§–∞–π–ª:** `Telegram/lib_base/base/platform/linux/base_info_linux.cpp`
**–§—É–Ω–∫—Ü–∏—è:** `DeviceModelPretty()`
**–°—Ç—Ä–æ–∫–∏:** 87-183

#### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö (DMI/SMBIOS):

**–ß–∏—Ç–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã –≤ `/sys/class/dmi/id/`:**
```cpp
const auto productName = readFile("/sys/class/dmi/id/product_name");
const auto productFamily = readFile("/sys/class/dmi/id/product_family");
const auto boardName = readFile("/sys/class/dmi/id/board_name");
const auto chassisType = readFile("/sys/class/dmi/id/chassis_type");
```

**Chassis Type Mapping:**
```cpp
switch (chassisType.toInt()) {
    case 3: case 4: case 5: case 6: case 7:
        return "Desktop";
    case 8: case 9: case 10: case 11: case 14:
        return "Laptop";
    case 11:
        return "Handset";
    case 13:
        return "Server";
    case 30: case 31: case 32:
        return "Tablet";
    case 31: case 32:
        return "Convertible";
}
```

**–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ HP –Ω–æ—É—Ç–±—É–∫–æ–≤:**
```cpp
// HP Laptop 15-bw0xx -> HP Laptop 15
// HP ENVY Notebook -> HP ENVY
if (productName.startsWith("HP ") && productName.contains('-')) {
    return productName.section('-', 0, 0);
}
```

**–ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
- `"ThinkPad X1 Carbon Gen 9"`
- `"Dell XPS 13 9310"`
- `"HP EliteBook 840"`
- `"Desktop"` (–¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ü–ö)

---

### Linux - System Version

**–§–∞–π–ª:** `Telegram/lib_base/base/platform/linux/base_info_linux.cpp`
**–§—É–Ω–∫—Ü–∏—è:** `SystemVersionPretty()`
**–°—Ç—Ä–æ–∫–∏:** 185-250

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–µ—Ä—Å–∏–∏:

**1. Kernel info (uname):**
```cpp
struct utsname uts;
uname(&uts);
QString kernel = QString::fromUtf8(uts.sysname);      // "Linux"
QString version = QString::fromUtf8(uts.release);     // "6.5.0-14-generic"
```

**2. Desktop Environment:**
```cpp
const auto xdgCurrentDesktop = qEnvironmentVariable("XDG_CURRENT_DESKTOP");
// –ü—Ä–∏–º–µ—Ä—ã: "KDE", "GNOME", "XFCE", "Unity", "Cinnamon"
```

**3. Window Manager/Display Server:**
```cpp
const auto sessionType = qEnvironmentVariable("XDG_SESSION_TYPE");
// "wayland", "x11", "tty"

const auto waylandDisplay = qEnvironmentVariable("WAYLAND_DISPLAY");
if (!waylandDisplay.isEmpty()) {
    return "Wayland";
} else if (sessionType == "x11") {
    return "X11";
}
```

**4. Glibc Version:**
```cpp
const auto glibcVersion = QString::fromUtf8(gnu_get_libc_version());
// –ü—Ä–∏–º–µ—Ä: "2.35"
```

**5. Virtualization Detection:**
```cpp
QProcess virt;
virt.start("systemd-detect-virt");
virt.waitForFinished();
const auto virtOutput = QString::fromUtf8(virt.readAllStandardOutput().trimmed());
// –ü—Ä–∏–º–µ—Ä—ã: "kvm", "vmware", "virtualbox", "none"
```

**–§–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
```
"Linux <kernel_version> <DE> (<display_server>) glibc <version>"
```

**–ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
- `"Linux 6.5.0 KDE (Wayland) glibc 2.38"`
- `"Linux 6.2.0 GNOME (X11) glibc 2.35"`
- `"Linux 5.15.0 XFCE glibc 2.31"`

---

### macOS - Device Model

**–§–∞–π–ª:** `Telegram/lib_base/base/platform/mac/base_info_mac.mm`
**–§—É–Ω–∫—Ü–∏—è:** `DeviceModelPretty()`
**–°—Ç—Ä–æ–∫–∏:** 121-179 (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ)

#### –ú–µ—Ç–æ–¥ 1: system_profiler (–æ—Å–Ω–æ–≤–Ω–æ–π)

```objc
NSTask *task = [[NSTask alloc] init];
[task setLaunchPath:@"/usr/sbin/system_profiler"];
[task setArguments:@[@"-json", @"SPHardwareDataType"]];

NSPipe *pipe = [NSPipe pipe];
[task setStandardOutput:pipe];
[task launch];

NSData *data = [[pipe fileHandleForReading] readDataToEndOfFile];
NSDictionary *json = [NSJSONSerialization JSONObjectWithData:data ...];

// –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ: SPHardwareDataType -> machine_model
NSString *model = json[@"SPHardwareDataType"][0][@"machine_model"];
```

**–ü—Ä–∏–º–µ—Ä JSON –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "SPHardwareDataType": [{
    "machine_model": "MacBook Air (M1, 2020)",
    "machine_name": "MacBook Air"
  }]
}
```

#### –ú–µ—Ç–æ–¥ 2: sysctl (fallback)

```cpp
char model[256];
size_t len = sizeof(model);
sysctlbyname("hw.model", model, &len, nullptr, 0);
// –†–µ–∑—É–ª—å—Ç–∞—Ç: "MacBookAir10,1"
```

**–ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
- `"MacBook Air M1"`
- `"MacBook Pro M2 Max"`
- `"Mac Studio M1 Ultra"`
- `"iMac 24-inch M1"`

---

### macOS - System Version

**–§–∞–π–ª:** `Telegram/lib_base/base/platform/mac/base_info_mac.mm`

#### –ú–µ—Ç–æ–¥: NSProcessInfo

```objc
NSOperatingSystemVersion version = [[NSProcessInfo processInfo] operatingSystemVersion];
NSString *versionString = [NSString stringWithFormat:@"macOS %ld.%ld.%ld",
    (long)version.majorVersion,
    (long)version.minorVersion,
    (long)version.patchVersion];
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ:**
```cpp
// –ß–µ—Ä–µ–∑ Qt
QSysInfo::productVersion();  // "14.0", "13.5.2", –∏ —Ç.–¥.
```

**–ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
- `"macOS 14.0"` (Sonoma)
- `"macOS 13.5"` (Ventura)
- `"macOS 12.6"` (Monterey)

---

## 3. –ú–ï–•–ê–ù–ò–ó–ú system_info.json

### –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

**–§–∞–π–ª—ã:**
- `Telegram/lib_base/base/platform/base_system_info_config.h` - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- `Telegram/lib_base/base/platform/base_system_info_config.cpp` - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### –ö–ª–∞—Å—Å SystemInfoConfig:

```cpp
namespace base::Platform {

class SystemInfoConfig {
public:
    static bool exists();                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞
    static QString configPath();             // –ü—É—Ç—å –∫ system_info.json
    static void load();                      // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    static void save(const ConfigData &data); // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

    static QString deviceModel();            // Getter –¥–ª—è device_model
    static QString systemVersion();          // Getter –¥–ª—è system_version
    static QString systemLangCode();         // Getter –¥–ª—è lang code
    // ...

private:
    static ConfigData _data;                 // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö
    static bool _loaded;                     // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
};

}
```

#### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–∞:

**–ü—É—Ç—å:** –†—è–¥–æ–º —Å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º —Ñ–∞–π–ª–æ–º

- **macOS:** `Telegram.app/Contents/MacOS/system_info.json`
- **Windows:** `C:\...\Telegram\system_info.json`
- **Linux:** `/usr/bin/system_info.json` –∏–ª–∏ —Ä—è–¥–æ–º —Å –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–º

**–§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—É—Ç–∏:**
```cpp
QString SystemInfoConfig::configPath() {
    return QCoreApplication::applicationDirPath() + "/system_info.json";
}
```

---

### –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ system_info.json

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "device_model": "Custom Device Name",
  "system_version": "Custom OS 1.0",
  "system_lang_code": "en-US",
  "lang_pack": "tdesktop",
  "lang_code": "en",
  "timezone_offset": 10800
}
```

#### –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª–µ–π:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|-----|----------|--------|
| **device_model** | String | –ò–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–º–∞–∫—Å. 255 —Å–∏–º–≤–æ–ª–æ–≤) | `"MacBook Pro 16"` |
| **system_version** | String | –í–µ—Ä—Å–∏—è –û–° | `"macOS 14.0"` |
| **system_lang_code** | String | –°–∏—Å—Ç–µ–º–Ω—ã–π —è–∑—ã–∫ (ISO 639-1 + ISO 3166-1) | `"ru-RU"` |
| **lang_pack** | String | –Ø–∑—ã–∫–æ–≤–æ–π –ø–∞–∫–µ—Ç | `"tdesktop"` |
| **lang_code** | String | –ö–æ–¥ —è–∑—ã–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (ISO 639-1) | `"en"` |
| **timezone_offset** | Integer | –°–º–µ—â–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ (—Å–µ–∫—É–Ω–¥—ã) | `10800` (UTC+3) |

---

### –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ fallback

**–§–∞–π–ª:** `Telegram/lib_base/base/platform/base_system_info_config.cpp`

#### –ê–ª–≥–æ—Ä–∏—Ç–º DeviceModelPretty():

```cpp
QString DeviceModelPretty() {
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ config —Ñ–∞–π–ª–∞
    if (SystemInfoConfig::exists()) {
        SystemInfoConfig::load();

        // 2. –ß–∏—Ç–∞–µ–º device_model –∏–∑ config
        QString configModel = SystemInfoConfig::deviceModel();
        if (!configModel.isEmpty()) {
            return configModel;  // ‚Üê –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∑ config
        }
    }

    // 3. Fallback: –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    QString realModel = DetectRealDeviceModel();

    // 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º config —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    SystemInfoConfig::save({
        .deviceModel = realModel,
        .systemVersion = DetectRealSystemVersion(),
        // ...
    });

    return realModel;
}
```

**–í–∞–∂–Ω–æ:** –§–∞–π–ª —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.

---

### –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–¥–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ

#### –®–∞–≥ 1: –ù–∞–π—Ç–∏ —Ñ–∞–π–ª

**macOS:**
```bash
cd /Applications/Telegram.app/Contents/MacOS/
ls -la system_info.json
```

**Windows:**
```powershell
cd "C:\Users\<User>\AppData\Roaming\Telegram Desktop"
dir system_info.json
```

**Linux:**
```bash
cd ~/.local/share/TelegramDesktop/
ls -la system_info.json
```

#### –®–∞–≥ 2: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å JSON

**–ü—Ä–∏–º–µ—Ä –ø–æ–¥–º–µ–Ω—ã:**
```json
{
  "device_model": "Anonymous Device",
  "system_version": "Generic OS 1.0",
  "system_lang_code": "en-US",
  "lang_pack": "tdesktop",
  "lang_code": "en",
  "timezone_offset": 0
}
```

#### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Telegram

–ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞:
1. –ó–∞–∫—Ä—ã—Ç—å Telegram –ø–æ–ª–Ω–æ—Å—Ç—å—é
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞
3. –ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ó–∞–π—Ç–∏ –≤ Settings ‚Üí Advanced ‚Üí Active Sessions
- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é - —Ç–∞–º –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞ `device_model`

---

### –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

**–§–∞–π–ª:** `Telegram/lib_base/base/platform/base_system_info_config.cpp`

#### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

```cpp
// –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ device_model
constexpr auto kMaxDeviceModelLength = 255;

QString deviceModel = config["device_model"].toString();
if (deviceModel.length() > kMaxDeviceModelLength) {
    deviceModel = deviceModel.left(kMaxDeviceModelLength);
}
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è JSON:**
- –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º JSON
- –ï—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —É–¥–∞–ª—Å—è - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –ù–µ—Ç —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Unicode: `"—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"`, `"Ë®≠ÂÇô"`
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –∏–Ω—ä–µ–∫—Ü–∏–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç.–∫. —ç—Ç–æ MTProto string)

---

## 4. TIMEZONE OFFSET

### –†–∞—Å—á–µ—Ç —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞

**–§–∞–π–ª:** `Telegram/SourceFiles/mtproto/session_private.cpp`
**–§—É–Ω–∫—Ü–∏—è:** `prepareInitParams()`
**–°—Ç—Ä–æ–∫–∏:** 549-570

#### –ê–ª–≥–æ—Ä–∏—Ç–º:

```cpp
QJsonObject SessionPrivate::prepareInitParams() const {
    // –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
    const auto now = QDateTime::currentDateTime();

    // –ü–æ–ª—É—á–∞–µ–º UTC –≤—Ä–µ–º—è
    const auto utc = QDateTime::currentDateTimeUtc();

    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    auto offset = now.secsTo(utc);

    // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –±–ª–∏–∂–∞–π—à–∏—Ö 15 –º–∏–Ω—É—Ç
    constexpr auto kRound = 15 * 60;  // 900 —Å–µ–∫—É–Ω–¥
    offset = ((offset + kRound / 2) / kRound) * kRound;

    // –§–æ—Ä–º–∏—Ä—É–µ–º JSON
    QJsonObject result;
    result["tz_offset"] = offset;

    return result;
}
```

#### –ü—Ä–∏–º–µ—Ä—ã:

| –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å | –°–º–µ—â–µ–Ω–∏–µ (—Å–µ–∫) | –°–º–µ—â–µ–Ω–∏–µ (—á–∞—Å—ã) |
|--------------|----------------|-----------------|
| UTC-12:00 | -43200 | -12 |
| UTC-05:00 (EST) | -18000 | -5 |
| UTC+00:00 (GMT) | 0 | 0 |
| UTC+03:00 (MSK) | 10800 | +3 |
| UTC+08:00 (CST) | 28800 | +8 |
| UTC+14:00 | 50400 | +14 |

**–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ:**
- UTC+03:07 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è –¥–æ UTC+03:00
- UTC+03:23 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è –¥–æ UTC+03:30
- UTC+03:38 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è –¥–æ UTC+03:30
- UTC+03:53 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è –¥–æ UTC+04:00

**–ó–∞—á–µ–º –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ?**
- –°–Ω–∏–∂–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å fingerprint'–∞
- –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–∞–º

---

## 5. CRASH REPORTING (Breakpad/Crashpad)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `Telegram/SourceFiles/core/crash_reports.h` - API
- `Telegram/SourceFiles/core/crash_reports.cpp` - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
- `Telegram/SourceFiles/core/crash_report_window.cpp` - UI –¥–∏–∞–ª–æ–≥
- `Telegram/lib_base/base/crash_report_writer.cpp` - –ë–∞–∑–æ–≤–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞

#### –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è:

**Windows/Linux:** Google Breakpad
```cpp
#include <client/windows/handler/exception_handler.h>
google_breakpad::ExceptionHandler _exceptionHandler;
```

**macOS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):** Crashpad
```cpp
#include <client/crashpad_client.h>
crashpad::CrashpadClient _crashpadClient;
```

**–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ:** –§–ª–∞–≥ `MAC_USE_BREAKPAD` –≤ CMake

---

### –ß—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ crash report

#### 1. –ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ (Annotations)

**–§–∞–π–ª:** `core/crash_reports.cpp`

```cpp
// –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
SetAnnotation("Binary", executableName);           // "Telegram"
SetAnnotation("ApiId", QString::number(ApiId));    // "2040"
SetAnnotation("Version", AppVersionStr);           // "6.2.4"
SetAnnotation("Launched", launchDateTime);         // "25.10.2025 14:30:22"
SetAnnotation("Platform", platformString);         // "MacOS", "Windows64Bit"
SetAnnotation("UserTag", userTagHex);              // Installation ID (hex)
```

**Platform Strings:**
- Windows Store: `"WinStore64Bit"`, `"WinStore32Bit"`, `"WinStoreARM64"`
- Windows Standard: `"Windows64Bit"`, `"Windows32Bit"`, `"WindowsARM64"`
- macOS: `"MacAppStore"` (App Store) –∏–ª–∏ `"MacOS"` (direct)
- Linux: `"Linux"`

#### 2. Memory Usage (Windows)

```cpp
PROCESS_MEMORY_COUNTERS memInfo;
GetProcessMemoryInfo(GetCurrentProcess(), &memInfo, sizeof(memInfo));

SetAnnotation("MemoryUsagePeak", QString::number(memInfo.PeakWorkingSetSize));
SetAnnotation("MemoryUsageCurrent", QString::number(memInfo.WorkingSetSize));
SetAnnotation("PagefileUsagePeak", QString::number(memInfo.PeakPagefileUsage));
SetAnnotation("PagefileUsageCurrent", QString::number(memInfo.PagefileUsage));
```

#### 3. Crash Details

```cpp
// –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∫—Ä–∞—à–∞
SetAnnotation("CrashSignal", signalName);          // "SIGSEGV", "SIGABRT"
SetAnnotation("CrashTime", currentDateTime);       // –í—Ä–µ–º—è –∫—Ä–∞—à–∞
SetAnnotation("MinidumpPath", dumpFilePath);       // –ü—É—Ç—å –∫ .dmp —Ñ–∞–π–ª—É
SetAnnotation("ThreadId", crashThreadId);          // ID –ø–æ—Ç–æ–∫–∞
```

#### 4. Qt Fatal Messages

```cpp
// –ï—Å–ª–∏ –±—ã–ª–æ Qt fatal —Å–æ–æ–±—â–µ–Ω–∏–µ
SetAnnotation("QtFatal", fatalMessage);
```

#### 5. Minidump File

**–§–æ—Ä–º–∞—Ç:** Windows Minidump (.dmp)
**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**
- Stack traces –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤
- Register values
- Memory dumps (—Å—Ç–µ–∫, heap regions)
- Module list (–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ DLL/SO)
- Exception information

**–†–∞–∑–º–µ—Ä:** –û–±—ã—á–Ω–æ 100 –ö–ë - 5 –ú–ë (—Å–∂–∏–º–∞–µ—Ç—Å—è –¥–æ ~50-500 –ö–ë –ø—Ä–∏ upload)

---

### Upload Endpoints

#### 1. Query Endpoint (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏)

**URL:** `https://tdesktop.com/crash.php?act=query_report`

**GET –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```
apiid=2040
version=6.2.4
dmp=1                      // 1 = –µ—Å—Ç—å minidump, 0 = –Ω–µ—Ç
platform=MacOS
```

**–û—Ç–≤–µ—Ç—ã:**
- `"Report"` - –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å crash report
- `"Old"` - –≤–µ—Ä—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞, –æ–±–Ω–æ–≤–∏—Ç–µ—Å—å
- `"Unofficial"` - –∫–∞—Å—Ç–æ–º–Ω–∞—è —Å–±–æ—Ä–∫–∞, –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è
- (–ø—É—Å—Ç–æ–π) - –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ

#### 2. Upload Endpoint

**URL:** `https://tdesktop.com/crash.php?act=report`

**–ú–µ—Ç–æ–¥:** POST (multipart/form-data)

**–ü–æ–ª—è:**
```
platform=MacOS
version=6.2.4
report=<compressed_text_report>    // –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç (gzip)
dump=<minidump.zip>                // Minidump —Ñ–∞–π–ª (zip)
```

**–†–∞–∑–º–µ—Ä—ã:**
- Report text: –æ–±—ã—á–Ω–æ <64 –ö–ë
- Minidump: max 20 –ú–ë (–ø–æ—Å–ª–µ —Å–∂–∞—Ç–∏—è)

---

### –ö–æ–Ω—Ç—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### UI Flow:

**–§–∞–π–ª:** `core/crash_report_window.cpp`

**1. –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫—Ä–∞—à–∞:**
```cpp
// –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ –ø–æ—Å–ª–µ –∫—Ä–∞—à–∞
if (crashReportExists()) {
    showCrashReportWindow();
}
```

**2. –î–∏–∞–ª–æ–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  Telegram crashed!                             ‚ïë
‚ïë                                                 ‚ïë
‚ïë  [View Report]  [Save to File]                 ‚ïë
‚ïë                                                 ‚ïë
‚ïë  [ ] Include my username (@username)           ‚ïë
‚ïë                                                 ‚ïë
‚ïë  [SEND CRASH REPORT]  [DON'T SEND]            ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

**3. –ö–Ω–æ–ø–∫–∏:**
- **SEND** - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- **DON'T SEND** - —É–¥–∞–ª–∏—Ç—å –æ—Ç—á–µ—Ç
- **View Report** - –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
- **Save to File** - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ (.telegramcrash)

#### Network Settings –≤ –¥–∏–∞–ª–æ–≥–µ:

**–ü—Ä–æ–∫—Å–∏ –¥–ª—è upload:**
```cpp
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å HTTP –ø—Ä–æ–∫—Å–∏
QString proxyHost;
int proxyPort;
QString proxyUsername;
QString proxyPassword;
```

–ü–æ–ª–µ–∑–Ω–æ –µ—Å–ª–∏:
- –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞–ø—Ä—è–º—É—é
- –¢—Ä–µ–±—É–µ—Ç—Å—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–∫—Å–∏
- Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç upload

---

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ crash reporting

#### Compile-time (–ø–æ–ª–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ):

**CMake —Ñ–ª–∞–≥:**
```cmake
-DTDESKTOP_DISABLE_CRASH_REPORTS=ON
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```cpp
#ifndef TDESKTOP_DISABLE_CRASH_REPORTS
    // –í–µ—Å—å –∫–æ–¥ crash reporting –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è –∏–∑ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
    CrashReports::Start();
#endif
```

#### Runtime (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è):

**–ö—Ä–∞—à-—Ä–µ–ø–æ—Ä—Ç—ã –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –µ—Å–ª–∏:**

1. **–ù–µ —Ç–µ—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è:**
```cpp
if (!cInstallBetaVersion() && !cAlphaVersion()) {
    return;  // –¢–æ–ª—å–∫–æ –¥–ª—è beta/alpha —Ç–µ—Å—Ç–µ—Ä–æ–≤
}
```

2. **OpenGL –∫—Ä–∞—à—ã:**
```cpp
if (crashContainsOpenGLError(report)) {
    return;  // –ü—Ä–æ–±–ª–µ–º—ã –¥—Ä–∞–π–≤–µ—Ä–æ–≤, –Ω–µ –Ω–∞—à–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
}
```

3. **–£—Å—Ç–∞—Ä–µ–≤—à–∞—è –≤–µ—Ä—Å–∏—è:**
```cpp
if (serverResponse == "Old") {
    showUpdatePrompt();
    return;
}
```

4. **–ù–µ–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞:**
```cpp
if (serverResponse == "Unofficial") {
    showMessage("Custom builds not accepted");
    return;
}
```

---

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ crash dumps

**–î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:**

**Windows:**
```
%APPDATA%\Telegram Desktop\tdata\dumps\
```

**macOS:**
```
~/Library/Application Support/Telegram Desktop/tdata/dumps/
~/Library/Application Support/Telegram Desktop/tdata/dumps/completed/
```

**Linux:**
```
~/.local/share/TelegramDesktop/tdata/dumps/
```

**–§–∞–π–ª—ã:**
- `{UUID}.dmp` - Minidump —Ñ–∞–π–ª—ã
- `working` - –¢–µ–∫—É—â–∏–π –æ—Ç—á–µ—Ç (—Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –∫—Ä–∞—Ö–µ)
- `report.telegramcrash` - –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

**–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞:**
- –°—Ç–∞—Ä—ã–µ dumps —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
- –ù–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ dumps –æ—Å—Ç–∞—é—Ç—Å—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞

---

## 6. –ß–¢–û –ù–ï –ù–ê–ô–î–ï–ù–û

### –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏

#### –ü–æ–∏—Å–∫ –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ:

**–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:** (0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
```bash
grep -r "google.*analytics\|firebase\|crashlytics" --include="*.cpp" --include="*.h"
grep -r "amplitude\|mixpanel\|segment\.com" --include="*.cpp"
grep -r "appsflyer\|adjust\.com\|branch\.io" --include="*.cpp"
grep -r "sentry\.io\|bugsnag\|raygun" --include="*.cpp"
```

**–í—ã–≤–æ–¥:** –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π —Å–æ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–º–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏.

---

### –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π behavioral tracking

#### Event Tracking (0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤):

```bash
grep -r "trackEvent\|logEvent\|recordEvent" --include="*.cpp"
grep -r "Analytics::track\|Analytics::log" --include="*.cpp"
grep -r "telemetry.*event\|metrics.*event" --include="*.cpp"
```

**–ß—Ç–æ –ù–ï –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è:**
- ‚ùå –ö–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º
- ‚ùå –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ–Ω—é
- ‚ùå –û—Ç–∫—Ä—ã—Ç–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π (stickers, GIFs, voice messages)
- ‚ùå –í—Ä–µ–º—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- ‚ùå –ß–∞—Å—Ç–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

---

### –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ A/B —Ç–µ—Å—Ç—ã

```bash
grep -r "experiment\|abtest\|feature.*flag\|variant" --include="*.cpp"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–µ—Ç —Å–∏—Å—Ç–µ–º—ã A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ feature flags.

---

### –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π user fingerprinting

```bash
grep -r "fingerprint\|canvas.*fingerprint\|webgl.*fingerprint" --include="*.cpp"
grep -r "deviceId\|uniqueId\|installationId" --include="*.cpp"
```

**–ß—Ç–æ –ù–ï —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è:**
- ‚ùå Canvas fingerprinting
- ‚ùå WebGL fingerprinting
- ‚ùå Font enumeration
- ‚ùå Installed plugins list
- ‚ùå Hardware concurrency (–¥–µ—Ç–∞–ª—å–Ω–æ–µ)
- ‚ùå Battery status

**–ß—Ç–æ –ï–°–¢–¨ (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ):**
- ‚úÖ Installation tag (–ª–æ–∫–∞–ª—å–Ω—ã–π hex ID, –¥–ª—è —Ä–∞–∑–ª–∏—á–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–æ–∫)
- ‚úÖ Platform detection (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞)

---

### –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∞—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è UI

```bash
grep -r "heatmap\|click.*track\|scroll.*depth" --include="*.cpp"
grep -r "session.*duration\|time.*spent" --include="*.cpp"
```

**–ß—Ç–æ –ù–ï –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è:**
- ‚ùå Heatmaps –∫–ª–∏–∫–æ–≤
- ‚ùå Scroll depth
- ‚ùå Mouse movements
- ‚ùå –í—Ä–µ–º—è –Ω–∞ —ç–∫—Ä–∞–Ω–∞—Ö
- ‚ùå Conversion funnels
- ‚ùå Feature discovery metrics

---

### –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∞—è —Å–µ—Ç–µ–≤–∞—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è

```bash
grep -r "network.*metrics\|bandwidth.*track\|latency.*track" --include="*.cpp"
```

**–ß—Ç–æ –ù–ï —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è:**
- ‚ùå –°–∫–æ—Ä–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- ‚ùå Latency –∫ —Å–µ—Ä–≤–µ—Ä–∞–º
- ‚ùå Packet loss
- ‚ùå Connection type (WiFi/LTE/5G)
- ‚ùå ISP –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–ß—Ç–æ –ï–°–¢–¨ (–¥–ª—è —Ä–∞–±–æ—Ç—ã):**
- ‚úÖ MTProto ping/pong (–¥–ª—è keepalive)
- ‚úÖ Data center selection (–¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)

---

## 7. –°–ï–¢–ï–í–´–ï ENDPOINTS

### MTProto —Å–µ—Ä–≤–µ—Ä—ã

**–§–∞–π–ª:** `Telegram/SourceFiles/mtproto/config.cpp`

**Data Centers:**
```
DC1: 149.154.175.50:443 (Miami, USA)
DC2: 149.154.167.50:443 (Amsterdam, Netherlands)
DC3: 149.154.175.100:443 (Miami, USA)
DC4: 149.154.167.91:443 (Amsterdam, Netherlands)
DC5: 91.108.56.130:443 (Singapore)
```

**–ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:**
- MTProto encrypted messages
- initConnection —Å —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- User messages, media, files
- API –∑–∞–ø—Ä–æ—Å—ã

**–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:** MTProto 2.0 (end-to-end –¥–ª—è Secret Chats)

---

### Crash Report Server

**Endpoint:** `https://tdesktop.com/crash.php`

**Actions:**
- `?act=query_report` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏
- `?act=report` - –∑–∞–≥—Ä—É–∑–∫–∞ crash dump

**–ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:**
- Platform string
- Version string
- Crash annotations
- Minidump file (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ö–æ–Ω—Ç—Ä–æ–ª—å:** –¢–æ–ª—å–∫–æ —Å —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

### Update Server

**–§–∞–π–ª:** `Telegram/SourceFiles/core/update_checker.cpp`

**Endpoints:**
- Official: `https://updates.tdesktop.com/`
- Alpha: Custom alpha channel URLs

**–ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:**
- –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è (–≤ URL –∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö)
- Platform (–¥–ª—è –≤—ã–±–æ—Ä–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞)

**–ß—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è:**
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
- –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
- –¶–∏—Ñ—Ä–æ–≤–∞—è –ø–æ–¥–ø–∏—Å—å (RSA)

**–ß–∞—Å—Ç–æ—Ç–∞:**
```cpp
constexpr auto kUpdateDelayConstPart = 8 * 3600 * 1000;  // 8 —á–∞—Å–æ–≤
constexpr auto kUpdateDelayRandPart = 8 * 3600 * 1000;   // +0-8 —á–∞—Å–æ–≤ —Ä–∞–Ω–¥–æ–º
```

**–í—ã–≤–æ–¥:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 8-16 —á–∞—Å–æ–≤.

---

### –ù–ï–¢ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö endpoints

**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ:**
- ‚ùå Google Analytics endpoints
- ‚ùå Facebook Pixel
- ‚ùå Third-party CDNs (–∫—Ä–æ–º–µ Telegram CDN)
- ‚ùå Ad networks
- ‚ùå Tracking pixels
- ‚ùå External analytics services

**–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:**
- Telegram MTProto servers
- Telegram CDN (–¥–ª—è –º–µ–¥–∏–∞)
- tdesktop.com (–¥–ª—è crash reports –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)
- Payment providers (Stripe, –∏ —Ç.–¥. - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ)

---

## 8. –§–ê–ô–õ–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### –ö–∞—Ä—Ç–∞ —Ñ–∞–π–ª–æ–≤ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

#### Core —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:

```
Telegram/lib_base/base/platform/
‚îú‚îÄ‚îÄ base_platform_info.h              ‚Üê –û–±—â–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
‚îú‚îÄ‚îÄ base_platform_info.cpp            ‚Üê –û–±—â–∞—è –ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ base_system_info_config.h         ‚Üê system_info.json API
‚îú‚îÄ‚îÄ base_system_info_config.cpp       ‚Üê –ß—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å config
‚îÇ
‚îú‚îÄ‚îÄ win/
‚îÇ   ‚îú‚îÄ‚îÄ base_info_win.cpp             ‚Üê Windows –¥–µ—Ç–µ–∫—Ü–∏—è (—Å—Ç—Ä–æ–∫–∏ 154-300)
‚îÇ   ‚îî‚îÄ‚îÄ base_info_win.h
‚îÇ
‚îú‚îÄ‚îÄ linux/
‚îÇ   ‚îú‚îÄ‚îÄ base_info_linux.cpp           ‚Üê Linux –¥–µ—Ç–µ–∫—Ü–∏—è (—Å—Ç—Ä–æ–∫–∏ 87-250)
‚îÇ   ‚îî‚îÄ‚îÄ base_info_linux.h
‚îÇ
‚îî‚îÄ‚îÄ mac/
    ‚îú‚îÄ‚îÄ base_info_mac.mm              ‚Üê macOS –¥–µ—Ç–µ–∫—Ü–∏—è (—Å—Ç—Ä–æ–∫–∏ 121-179)
    ‚îî‚îÄ‚îÄ base_info_mac.h
```

#### MTProto transmission:

```
Telegram/SourceFiles/mtproto/
‚îú‚îÄ‚îÄ session_private.cpp               ‚Üê initConnection (—Å—Ç—Ä–æ–∫–∏ 689-726)
‚îú‚îÄ‚îÄ session_private.h
‚îú‚îÄ‚îÄ mtp_instance.cpp                  ‚Üê –•—Ä–∞–Ω–µ–Ω–∏–µ device_model/system_version
‚îú‚îÄ‚îÄ mtp_instance.h
‚îî‚îÄ‚îÄ config.cpp                        ‚Üê DC endpoints
```

#### Account initialization:

```
Telegram/SourceFiles/main/
‚îî‚îÄ‚îÄ main_account.cpp                  ‚Üê –°–±–æ—Ä —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 415-424)
```

#### Crash reporting:

```
Telegram/SourceFiles/core/
‚îú‚îÄ‚îÄ crash_reports.h                   ‚Üê Public API
‚îú‚îÄ‚îÄ crash_reports.cpp                 ‚Üê Breakpad integration
‚îú‚îÄ‚îÄ crash_report_window.h             ‚Üê UI –¥–∏–∞–ª–æ–≥
‚îî‚îÄ‚îÄ crash_report_window.cpp

Telegram/lib_base/base/
‚îî‚îÄ‚îÄ crash_report_writer.cpp           ‚Üê –ë–∞–∑–æ–≤–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–ø–∏—Å–∏
```

#### API endpoints:

```
Telegram/SourceFiles/api/
‚îú‚îÄ‚îÄ api_authorizations.cpp            ‚Üê –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ Active Sessions (—Å—Ç—Ä–æ–∫–∞ 59, 69)
‚îî‚îÄ‚îÄ api_statistics.cpp                ‚Üê –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ (–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è)
```

---

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö

#### 1. –ü—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É:

**–§–∞–π–ª:** `mtproto/session_private.cpp:689-726`
```cpp
SessionPrivate::sendPrepared(const SerializedRequest &request) {
    // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –≤ initConnection
    auto initWrapper = MTPInitConnection<SerializedRequest>(...);
    // ‚Üê –ó–î–ï–°–¨ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è device_model, system_version, –∏ —Ç.–¥.
}
```

**–ß–∞—Å—Ç–æ—Ç–∞:** –ü—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ (reconnect, DC change)

---

#### 2. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ (—Å–æ–∑–¥–∞–Ω–∏–µ config):

**–§–∞–π–ª:** `base/platform/base_system_info_config.cpp`
```cpp
QString DeviceModelPretty() {
    if (!SystemInfoConfig::exists()) {
        auto realData = DetectRealSystemInfo();
        SystemInfoConfig::save(realData);  // ‚Üê –°–æ–∑–¥–∞–Ω–∏–µ system_info.json
    }
}
```

**–ß–∞—Å—Ç–æ—Ç–∞:** –û–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ

---

#### 3. –ü—Ä–∏ –∫—Ä–∞—Ö–µ (—Å —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):

**–§–∞–π–ª:** `core/crash_reports.cpp`
```cpp
void SendCrashReport() {
    // Query server
    http.get("https://tdesktop.com/crash.php?act=query_report&...");

    // Upload report
    http.post("https://tdesktop.com/crash.php?act=report", multipartData);
    // ‚Üê –ó–î–ï–°–¨ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è minidump –∏ annotations
}
```

**–ß–∞—Å—Ç–æ—Ç–∞:** –¢–æ–ª—å–∫–æ –ø—Ä–∏ –∫—Ä–∞—Ö–µ + —è–≤–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

#### 4. –ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:

**–§–∞–π–ª:** `core/update_checker.cpp`
```cpp
void UpdateChecker::check() {
    // –ó–∞–ø—Ä–æ—Å –Ω–∞ update server
    http.get("https://updates.tdesktop.com/<platform>/<version>");
    // ‚Üê Platform –≤ URL
}
```

**–ß–∞—Å—Ç–æ—Ç–∞:** –ö–∞–∂–¥—ã–µ 8-16 —á–∞—Å–æ–≤

---

## 9. –ü–†–ò–í–ê–¢–ù–û–°–¢–¨ –ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### –ß—Ç–æ –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å

| –î–∞–Ω–Ω—ã–µ | –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å? | –ö–∞–∫? |
|--------|------------------|------|
| **Device Model** | ‚úÖ –î–∞ | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å `system_info.json` |
| **System Version** | ‚úÖ –î–∞ | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å `system_info.json` |
| **System Language** | ‚úÖ –î–∞ | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å `system_info.json` |
| **App Language** | ‚úÖ –î–∞ | Settings ‚Üí Language |
| **Timezone Offset** | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –ò–∑–º–µ–Ω–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å |
| **Crash Reports** | ‚úÖ –î–∞ | –ù–µ –Ω–∞–∂–∏–º–∞—Ç—å "SEND" –∏–ª–∏ `-DTDESKTOP_DISABLE_CRASH_REPORTS` |
| **Update Checks** | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å updates.tdesktop.com –≤ hosts/firewall |
| **MTProto Connection** | ‚ùå –ù–µ—Ç | –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |

---

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ

#### MTProto 2.0 Encryption:

**–ê–ª–≥–æ—Ä–∏—Ç–º—ã:**
- **Key exchange:** Diffie-Hellman (2048-bit)
- **Symmetric encryption:** AES-256-IGE
- **Hash:** SHA-256
- **Authentication:** SHA-256 based

**–°—Ö–µ–º–∞:**
```
–î–∞–Ω–Ω—ã–µ ‚Üí AES-256-IGE ‚Üí MTProto padding ‚Üí Telegram Server
   ‚Üë
   ‚îî‚îÄ‚îÄ Unique session key –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Perfect Forward Secrecy –¥–ª—è Secret Chats
- Server-Client encryption –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —á–∞—Ç–æ–≤
- –ù–µ—Ç Man-in-the-Middle –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–ª—é—á–µ–π)

---

### –ù–µ—Ç —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ:**
- ‚úÖ –î–∞–Ω–Ω—ã–µ –∏–¥—É—Ç –¢–û–õ–¨–ö–û –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ã Telegram
- ‚úÖ –ù–µ—Ç Google Analytics, Facebook SDK, –∏ —Ç.–¥.
- ‚úÖ –ù–µ—Ç —Ä–µ–∫–ª–∞–º–Ω—ã—Ö —Å–µ—Ç–µ–π
- ‚úÖ –ù–µ—Ç tracking pixels
- ‚úÖ Crash reports –∏–¥—É—Ç –Ω–∞ tdesktop.com (Telegram)

**–ò—Å–∫–ª—é—á–µ–Ω–∏—è:**
- Payment providers (Stripe, PayPal) - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ, –Ω–µ –¥–ª—è tracking

---

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏

#### 1. –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

**–°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π system_info.json:**
```json
{
  "device_model": "Desktop",
  "system_version": "Linux",
  "system_lang_code": "en",
  "lang_pack": "tdesktop",
  "lang_code": "en",
  "timezone_offset": 0
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –°–∫—Ä—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –£–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –û–°
- –ú–∞—Å–∫–∏—Ä—É–µ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ú–æ–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å—Å—è —Å—Ä–µ–¥–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ú–æ–∂–µ—Ç –∑–∞—Ç—Ä—É–¥–Ω–∏—Ç—å support (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

---

#### 2. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ crash reports

**Compile-time:**
```bash
cmake -DTDESKTOP_DISABLE_CRASH_REPORTS=ON ..
make
```

**Runtime:**
- –ü—Ä–æ—Å—Ç–æ –Ω–µ –Ω–∞–∂–∏–º–∞—Ç—å "SEND CRASH REPORT"
- –£–¥–∞–ª–∏—Ç—å `tdata/dumps/` –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é

---

#### 3. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ update checks

**Hosts file:**
```
127.0.0.1 updates.tdesktop.com
::1 updates.tdesktop.com
```

**Firewall:**
```bash
# Linux (iptables)
iptables -A OUTPUT -d updates.tdesktop.com -j REJECT

# Windows (PowerShell as Admin)
New-NetFirewallRule -DisplayName "Block Telegram Updates" `
  -Direction Outbound -Action Block -RemoteAddress updates.tdesktop.com
```

**‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:** –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ (–Ω–µ—Ç security patches).

---

#### 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MTProto Proxy

**–ó–∞—á–µ–º:**
- –°–∫—Ä—ã–≤–∞–µ—Ç IP –∞–¥—Ä–µ—Å –æ—Ç Telegram —Å–µ—Ä–≤–µ—Ä–æ–≤
- –ú–∞—Å–∫–∏—Ä—É–µ—Ç traffic –æ—Ç ISP
- –û–±—Ö–æ–¥–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
- Settings ‚Üí Advanced ‚Üí Connection type ‚Üí Use custom proxy
- –í—ã–±—Ä–∞—Ç—å MTProto proxy

**–ß—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è:**
- –†–µ–∞–ª—å–Ω—ã–π IP –∞–¥—Ä–µ—Å
- –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ IP

**–ß—Ç–æ –ù–ï —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è:**
- Device model, system version (–µ—Å–ª–∏ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω config)
- Timezone offset (–º–æ–∂–µ—Ç –∫–æ—Å–≤–µ–Ω–Ω–æ —É–∫–∞–∑–∞—Ç—å –ª–æ–∫–∞—Ü–∏—é)

---

#### 5. Timezone spoofing

**–ò–∑–º–µ–Ω–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å:**

**Windows:**
```powershell
Set-TimeZone -Id "UTC"
```

**macOS:**
```bash
sudo systemsetup -settimezone "UTC"
```

**Linux:**
```bash
timedatectl set-timezone UTC
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VPN –≤ –¥—Ä—É–≥–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è.

---

## 10. –ö–û–î-–ü–†–ò–ú–ï–†–´

### –ü—Ä–∏–º–µ—Ä 1: initConnection Request

**–†–µ–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ `mtproto/session_private.cpp:689-726`:**

```cpp
SerializedRequest SessionPrivate::sendPrepared(
        const SerializedRequest &request) {

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–ª–µ–π
    const auto deviceModel = _instance->deviceModel();
    const auto systemVersion = _instance->systemVersion();
    const auto appVersion = QString("%1 %2")
        .arg(AppVersionStr)
        .arg(QSysInfo::buildCpuArchitecture());
    const auto systemLangCode = _instance->systemLangCode();
    const auto cloudLangCode = _instance->cloudLangCode();

    // –ü—Ä–æ–∫—Å–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
    MTPInputClientProxy clientProxyFields = MTP_inputClientProxy(
        MTP_string(proxyHost),
        MTP_int(proxyPort)
    );

    // JSON –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (timezone)
    const auto params = prepareInitParams();

    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ MTProto –∑–∞–ø—Ä–æ—Å–∞
    auto initWrapper = MTPInitConnection<SerializedRequest>(
        MTP_flags(proxyFlags),
        MTP_int(ApiId),                      // 2040
        MTP_string(deviceModel),             // "MacBook Air M1"
        MTP_string(systemVersion),           // "macOS 14.0"
        MTP_string(appVersion),              // "6.2.4 x86_64"
        MTP_string(systemLangCode),          // "en-US"
        MTP_string(_instance->langPackName()), // "tdesktop"
        MTP_string(cloudLangCode),           // "en"
        clientProxyFields,
        MTP_jsonObject(params),              // {"tz_offset": 10800}
        SerializedRequest(request)
    );

    return initWrapper;
}
```

**TL —Å—Ö–µ–º–∞:**
```tl
initConnection#c1cd5ea9 {X:Type}
  flags:#
  api_id:int
  device_model:string
  system_version:string
  app_version:string
  system_lang_code:string
  lang_pack:string
  lang_code:string
  proxy:flags.0?InputClientProxy
  params:flags.1?JSONValue
  query:!X
  = X;
```

---

### –ü—Ä–∏–º–µ—Ä 2: Platform Detection (Windows)

**–§–∞–π–ª:** `lib_base/base/platform/win/base_info_win.cpp`

```cpp
QString DeviceModelPretty() {
    // –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è Registry
    const auto readRegistry = [](LPCWSTR path, LPCWSTR key) -> QString {
        QString result;
        HKEY rootKey;

        if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, path, 0,
                        KEY_READ, &rootKey) == ERROR_SUCCESS) {
            DWORD size = 0;
            RegQueryValueEx(rootKey, key, 0, nullptr, nullptr, &size);

            if (size > 0) {
                auto buffer = QByteArray(size, Qt::Uninitialized);
                if (RegQueryValueEx(rootKey, key, 0, nullptr,
                    reinterpret_cast<LPBYTE>(buffer.data()),
                    &size) == ERROR_SUCCESS) {
                    result = QString::fromWCharArray(
                        reinterpret_cast<const wchar_t*>(
                            buffer.constData()));
                }
            }
            RegCloseKey(rootKey);
        }
        return result.trimmed();
    };

    // –ß—Ç–µ–Ω–∏–µ –∏–∑ Registry
    const auto biosPath = L"HARDWARE\\Description\\System\\BIOS";

    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: SystemProductName
    auto result = readRegistry(biosPath, L"SystemProductName");
    if (!result.isEmpty() && result != "System Product Name") {
        return result;
    }

    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: SystemFamily
    result = readRegistry(biosPath, L"SystemFamily");
    if (!result.isEmpty() && result != "To be filled by O.E.M.") {
        return result;
    }

    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: BaseBoardProduct
    result = readRegistry(biosPath, L"BaseBoardProduct");
    if (!result.isEmpty() && result != "Base Board Product Name") {
        return result;
    }

    // Fallback
    return "Desktop";
}
```

---

### –ü—Ä–∏–º–µ—Ä 3: Platform Detection (Linux DMI)

**–§–∞–π–ª:** `lib_base/base/platform/linux/base_info_linux.cpp`

```cpp
QString DeviceModelPretty() {
    // –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    const auto readFile = [](const QString &path) -> QString {
        QFile file(path);
        if (file.open(QIODevice::ReadOnly | QIODevice::Text)) {
            return QString::fromUtf8(file.readAll()).trimmed();
        }
        return QString();
    };

    // –ß—Ç–µ–Ω–∏–µ DMI –¥–∞–Ω–Ω—ã—Ö
    const auto productName = readFile(
        "/sys/class/dmi/id/product_name");
    const auto productFamily = readFile(
        "/sys/class/dmi/id/product_family");
    const auto boardName = readFile(
        "/sys/class/dmi/id/board_name");
    const auto chassisType = readFile(
        "/sys/class/dmi/id/chassis_type");

    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: product_name
    if (!productName.isEmpty()
        && productName != "To Be Filled By O.E.M."
        && productName != "System Product Name"
        && productName != "Default string") {

        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ HP
        if (productName.startsWith("HP ")) {
            // "HP Laptop 15-bw0xx" -> "HP Laptop 15"
            if (productName.contains('-')) {
                return productName.section('-', 0, 0);
            }
        }

        return productName;
    }

    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: product_family
    if (!productFamily.isEmpty()) {
        return productFamily;
    }

    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: board_name
    if (!boardName.isEmpty()) {
        return boardName;
    }

    // Fallback: –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ chassis
    const auto type = chassisType.toInt();
    switch (type) {
        case 3: case 4: case 5: case 6: case 7:
            return "Desktop";
        case 8: case 9: case 10: case 11: case 14:
            return "Laptop";
        case 30: case 31: case 32:
            return "Tablet";
        default:
            return QString();
    }
}
```

---

### –ü—Ä–∏–º–µ—Ä 4: Crash Report Annotations

**–§–∞–π–ª:** `core/crash_reports.cpp`

```cpp
void CrashReports::Start() {
    // –ë–∞–∑–æ–≤—ã–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏
    SetAnnotation("Binary", QFileInfo(
        QCoreApplication::applicationFilePath()).fileName());

    SetAnnotation("ApiId", QString::number(ApiId));

    SetAnnotation("Version", QString::fromLatin1(AppVersionStr));

    SetAnnotation("Launched", QDateTime::currentDateTime()
        .toString("dd.MM.yyyy hh:mm:ss"));

    // Platform string
    QString platform;
#ifdef Q_OS_WIN
    if (cWindowsStore()) {
        platform = IsARM64() ? "WinStoreARM64"
                 : Is64Bit() ? "WinStore64Bit"
                             : "WinStore32Bit";
    } else {
        platform = IsARM64() ? "WindowsARM64"
                 : Is64Bit() ? "Windows64Bit"
                             : "Windows32Bit";
    }
#elif defined Q_OS_MAC
    platform = cMacAppStore() ? "MacAppStore" : "MacOS";
#else
    platform = "Linux";
#endif

    SetAnnotation("Platform", platform);

    // Installation tag (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
    const auto installationTag = GetInstallationTag();
    SetAnnotation("UserTag", QString::number(installationTag, 16));

    // Windows: Memory usage
#ifdef Q_OS_WIN
    PROCESS_MEMORY_COUNTERS memInfo;
    if (GetProcessMemoryInfo(GetCurrentProcess(),
                            &memInfo, sizeof(memInfo))) {
        SetAnnotation("MemoryUsagePeak",
            QString::number(memInfo.PeakWorkingSetSize));
        SetAnnotation("MemoryUsageCurrent",
            QString::number(memInfo.WorkingSetSize));
    }
#endif

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    InstallExceptionHandlers();
}
```

---

### –ü—Ä–∏–º–µ—Ä 5: system_info.json Override

**–†–µ–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –∏–∑ `base/platform/base_system_info_config.cpp`:**

```cpp
namespace base::Platform {

struct ConfigData {
    QString deviceModel;
    QString systemVersion;
    QString systemLangCode;
    QString langPack;
    QString langCode;
    int timezoneOffset = 0;
};

ConfigData _configData;
bool _configLoaded = false;

QString SystemInfoConfig::configPath() {
    return QCoreApplication::applicationDirPath()
        + "/system_info.json";
}

bool SystemInfoConfig::exists() {
    return QFile::exists(configPath());
}

void SystemInfoConfig::load() {
    if (_configLoaded) {
        return;
    }

    QFile file(configPath());
    if (!file.open(QIODevice::ReadOnly | QIODevice::Text)) {
        return;
    }

    const auto data = file.readAll();
    QJsonParseError error;
    const auto doc = QJsonDocument::fromJson(data, &error);

    if (error.error != QJsonParseError::NoError) {
        return; // JSON parse error - fallback to real values
    }

    const auto obj = doc.object();
    _configData.deviceModel = obj["device_model"].toString();
    _configData.systemVersion = obj["system_version"].toString();
    _configData.systemLangCode = obj["system_lang_code"].toString();
    _configData.langPack = obj["lang_pack"].toString();
    _configData.langCode = obj["lang_code"].toString();
    _configData.timezoneOffset = obj["timezone_offset"].toInt();

    _configLoaded = true;
}

void SystemInfoConfig::save(const ConfigData &data) {
    QJsonObject obj;
    obj["device_model"] = data.deviceModel;
    obj["system_version"] = data.systemVersion;
    obj["system_lang_code"] = data.systemLangCode;
    obj["lang_pack"] = data.langPack;
    obj["lang_code"] = data.langCode;
    obj["timezone_offset"] = data.timezoneOffset;

    QJsonDocument doc(obj);

    QFile file(configPath());
    if (file.open(QIODevice::WriteOnly | QIODevice::Text)) {
        file.write(doc.toJson(QJsonDocument::Indented));
    }
}

QString DeviceModelPretty() {
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å config –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (exists()) {
        load();
        if (!_configData.deviceModel.isEmpty()) {
            return _configData.deviceModel;  // ‚Üê –í–æ–∑–≤—Ä–∞—Ç –∏–∑ config
        }
    }

    // Fallback: –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    const auto realModel = DetectRealDeviceModel();

    // –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ config —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    if (!exists()) {
        ConfigData autoData;
        autoData.deviceModel = realModel;
        autoData.systemVersion = DetectRealSystemVersion();
        autoData.systemLangCode = DetectSystemLanguage();
        autoData.langPack = "tdesktop";
        autoData.langCode = "en";
        autoData.timezoneOffset = CalculateTimezoneOffset();
        save(autoData);
    }

    return realModel;
}

} // namespace base::Platform
```

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ Telegram Desktop

**–£—Ä–æ–≤–µ–Ω—å —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:** –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô

**–ß—Ç–æ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è:**
1. ‚úÖ **–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** - –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã MTProto –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
2. ‚úÖ **–ö—Ä–∞—à-—Ä–µ–ø–æ—Ä—Ç—ã** - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã, —Ç—Ä–µ–±—É—é—Ç —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ß—Ç–æ –ù–ï —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è:**
- ‚ùå –ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- ‚ùå –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ tracking —Å–µ—Ä–≤–∏—Å—ã
- ‚ùå Fingerprinting
- ‚ùå A/B —Ç–µ—Å—Ç—ã
- ‚ùå Feature usage metrics

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞–º–∏

| –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä | –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è | Crash Reports | Analytics | –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ SDK |
|------------|---------------------|---------------|-----------|---------------|
| **Telegram Desktop** | ‚úÖ –î–∞ (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å) | ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚ùå –ù–µ—Ç | ‚ùå –ù–µ—Ç |
| WhatsApp Desktop | ‚úÖ –î–∞ | ‚úÖ –î–∞ | ‚úÖ –î–∞ (Facebook) | ‚úÖ –î–∞ |
| Discord | ‚úÖ –î–∞ | ‚úÖ –î–∞ | ‚úÖ –î–∞ | ‚úÖ –î–∞ |
| Signal Desktop | ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ | ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚ùå –ù–µ—Ç | ‚ùå –ù–µ—Ç |
| Slack | ‚úÖ –î–∞ | ‚úÖ –î–∞ | ‚úÖ –î–∞ (extensive) | ‚úÖ –î–∞ |

### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `system_info.json`
- ‚úÖ –û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ crash reports
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MTProto proxy –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è IP
- ‚úÖ –û—Ç–∫—Ä—ã—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –¥–ª—è –∞—É–¥–∏—Ç–∞

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏:**
1. –°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π `system_info.json` —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
2. –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å crash reports
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MTProto proxy
4. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –Ω–∞ UTC

**–î–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
- –û—Å—Ç–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- Telegram Desktop –∏–º–µ–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é –∏–∑ –∫–æ—Ä–æ–±–∫–∏

### –§–∞–π–ª—ã –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

**–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
- `lib_base/base/platform/win/base_info_win.cpp:154-300`
- `lib_base/base/platform/linux/base_info_linux.cpp:87-250`
- `lib_base/base/platform/mac/base_info_mac.mm:121-179`

**–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö:**
- `mtproto/session_private.cpp:689-726`
- `main/main_account.cpp:415-424`

**Crash reporting:**
- `core/crash_reports.cpp`
- `core/crash_report_window.cpp`

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- `lib_base/base/platform/base_system_info_config.cpp`

### –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

- ‚úÖ –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã (>200,000 —Å—Ç—Ä–æ–∫)
- ‚úÖ –ü–æ–∏—Å–∫ –≤—Å–µ—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤ (0 –Ω–∞–π–¥–µ–Ω–æ)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö endpoints
- ‚úÖ –ê–Ω–∞–ª–∏–∑ MTProto –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
- ‚úÖ –ò–∑—É—á–µ–Ω–∏–µ crash reporting —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–π –¥–µ—Ç–µ–∫—Ü–∏–∏
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ system_info.json –º–µ—Ö–∞–Ω–∏–∑–º–∞
- ‚úÖ –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

**–î–∞—Ç–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:** 2025-10-25
**–í–µ—Ä—Å–∏—è –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã:** branch `system_info`, commit `aa6fc6a8b5`
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ - Telegram Desktop –∏–º–µ–µ—Ç –ú–ò–ù–ò–ú–ê–õ–¨–ù–£–Æ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é, –Ω–µ—Ç —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

