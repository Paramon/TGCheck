# Механизм конфигурации системной информации

## Описание

Реализован механизм для переопределения системной информации, отправляемой на серверы Telegram через файл конфигурации `system_info.json`.

## Как работает

1. **При первом запуске**: Если файл `system_info.json` не существует рядом с исполняемым файлом приложения, он будет автоматически создан с текущими реальными значениями системной информации.

2. **При последующих запусках**: Приложение читает значения из файла `system_info.json` и использует их вместо реальных системных данных.

3. **Если файл удален**: При следующем запуске файл будет пересоздан с актуальными системными данными.

## Расположение файла

Файл `system_info.json` должен находиться **рядом с исполняемым файлом**:
- **macOS**: Рядом с `Telegram.app`
- **Windows**: Рядом с `Telegram.exe`
- **Linux**: Рядом с бинарным файлом `Telegram`

## Структура файла

```json
{
  "_comment": "Auto-generated. Edit values to override system info sent to Telegram servers.",
  "device_model": "MacBook Air M1",
  "system_version": "macOS 14.0",
  "system_lang_code": "en-US",
  "lang_pack": "tdesktop",
  "lang_code": "en",
  "timezone_offset": 10800
}
```

### Поля конфигурации

| Поле | Описание | Пример значения | Обязательное |
|------|----------|-----------------|--------------|
| `device_model` | Модель устройства | `"MacBook Air M1"`, `"Desktop"`, `"HP EliteBook 840"` | Да |
| `system_version` | Версия операционной системы | `"macOS 14.0"`, `"Windows 11 x64"`, `"Linux 6.5.0 KDE Wayland glibc 2.38"` | Да |
| `system_lang_code` | Язык системы (ISO 639-1 + ISO 3166-1) | `"en-US"`, `"ru-RU"`, `"de-DE"` | Да |
| `lang_pack` | Название языкового пакета | `"tdesktop"` | Да |
| `lang_code` | Код языка в приложении (ISO 639-1) | `"en"`, `"ru"`, `"de"` | Да |
| `timezone_offset` | Смещение часового пояса в секундах | `10800` (UTC+3), `0` (UTC), `-18000` (UTC-5) | Нет |

### Особенности

- **`timezone_offset`** - опциональное поле. Если не указано, будет вычисляться реальное значение при каждом подключении.
- **`_comment`** - служебное поле с описанием, игнорируется при чтении.

## Примеры значений

### macOS
```json
{
  "device_model": "MacBook Pro M2 Max",
  "system_version": "macOS 14.0",
  "system_lang_code": "en-US",
  "lang_pack": "tdesktop",
  "lang_code": "en",
  "timezone_offset": -28800
}
```

### Windows
```json
{
  "device_model": "Desktop",
  "system_version": "Windows 11 x64",
  "system_lang_code": "ru-RU",
  "lang_pack": "tdesktop",
  "lang_code": "ru",
  "timezone_offset": 10800
}
```

### Linux
```json
{
  "device_model": "ThinkPad X1 Carbon",
  "system_version": "Linux 6.5.0 GNOME Wayland glibc 2.38",
  "system_lang_code": "de-DE",
  "lang_pack": "tdesktop",
  "lang_code": "de",
  "timezone_offset": 3600
}
```

## Использование

### Автоматическое создание конфигурации

1. Запустите приложение Telegram Desktop
2. Файл `system_info.json` будет автоматически создан с текущими реальными данными
3. Проверьте файл рядом с исполняемым файлом

### Ручное редактирование конфигурации

1. Откройте файл `system_info.json` в текстовом редакторе
2. Измените нужные значения
3. Сохраните файл
4. Перезапустите Telegram Desktop

### Сброс к реальным значениям

Просто удалите файл `system_info.json` - при следующем запуске он будет пересоздан с актуальными системными данными.

## Расчет timezone_offset

Значение `timezone_offset` указывается в секундах относительно UTC:

- **UTC+3** (Москва): `10800` (3 * 3600)
- **UTC+0** (Лондон): `0`
- **UTC-5** (Нью-Йорк): `-18000` (-5 * 3600)
- **UTC+8** (Пекин): `28800` (8 * 3600)

Формула: `timezone_offset = часы_от_UTC * 3600`

## Технические детали

### Измененные файлы

1. **Новые файлы**:
   - `Telegram/lib_base/base/platform/base_system_info_config.h`
   - `Telegram/lib_base/base/platform/base_system_info_config.cpp`

2. **Модифицированные файлы**:
   - `Telegram/lib_base/base/platform/win/base_info_win.cpp`
   - `Telegram/lib_base/base/platform/linux/base_info_linux.cpp`
   - `Telegram/lib_base/base/platform/mac/base_info_mac.mm`
   - `Telegram/SourceFiles/mtproto/session_private.cpp`

### Логика работы

1. При вызове `DeviceModelPretty()` или `SystemVersionPretty()`:
   - Проверяется наличие файла `system_info.json`
   - Если файл существует - загружается и используется значение из него
   - Если файла нет - собираются реальные данные и создается файл
   - Если значение в файле пустое - используется реальное значение

2. При вызове `prepareInitParams()` (timezone):
   - Проверяется наличие `timezone_offset` в конфиге
   - Если есть - используется значение из конфига
   - Если нет - вычисляется реальное значение

## Предупреждения

- Изменение системной информации может привести к проблемам с аккаунтом, если серверы Telegram обнаружат подозрительную активность
- Используйте эту функциональность на свой риск
- Не рекомендуется использовать на основных аккаунтах
- Файл конфигурации находится в открытом виде, храните его в безопасном месте

## Отладка

Если что-то не работает:

1. Проверьте, что файл `system_info.json` находится в правильной директории
2. Проверьте синтаксис JSON в файле (можно использовать онлайн-валидаторы)
3. Убедитесь, что все обязательные поля заполнены
4. Попробуйте удалить файл и пересоздать его автоматически
5. Проверьте логи приложения на наличие ошибок

## Пример файла

См. файл `system_info.json.example` в этой директории.
